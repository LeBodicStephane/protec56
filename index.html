<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöë Inventaire Protection Civile 56</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #ff6600 0%, #ff8c00 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 102, 0, 0.3);
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-admin { background: #ff0000; }
        .badge-chef-poste { background: #ff6600; }
        .badge-chef-equipe { background: #0088ff; }
        .badge-chef-binome { background: #00aa00; }
        
        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #ffa500;
        }
        
        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
        }
        
        .stat-card.green .number { color: #00ff88; }
        .stat-card.orange .number { color: #ff8c00; }
        .stat-card.red .number { color: #ff4444; }
        .stat-card.blue .number { color: #4488ff; }
        
        /* Controls */
        .controls {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .controls-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff6600, #ff8c00);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00aa00, #00ff00);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #cc0000, #ff0000);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #0066cc, #0088ff);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #555, #777);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff8800, #ffaa00);
            color: white;
            font-weight: bold;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #ff9900, #ffbb00);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 136, 0, 0.4);
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            flex: 1;
            min-width: 200px;
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        select option {
            background: #1a1a2e;
            color: white;
        }
        
        /* Table */
        .table-container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            overflow-x: auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        th {
            background: rgba(255,102,0,0.3);
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        tr.stock-alert {
            background: rgba(255, 140, 0, 0.2);
            border-left: 4px solid #ff8c00;
        }
        
        tr.stock-critical {
            background: rgba(255, 68, 68, 0.2);
            border-left: 4px solid #ff4444;
        }
        
        .status-ok { color: #00ff88; }
        .status-low { color: #ff8c00; }
        .status-critical { color: #ff4444; }
        
        .quantity-display {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .quantity-number {
            font-size: 28px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        
        .quantity-number:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 18px;
            min-width: 40px;
            min-height: 40px;
        }
        
        .btn-quick-remove {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            font-size: 24px;
            font-weight: bold;
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.4);
        }
        
        .btn-quick-remove:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 68, 68, 0.6);
        }
        
        .btn-quick-remove:active {
            transform: translateY(0);
        }
        
        .item-name-mobile {
            font-size: 18px;
            font-weight: bold;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,102,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,102,0,0.3);
        }
        
        .close {
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            color: #ff6600;
            line-height: 1;
        }
        
        .close:hover {
            color: #ff8c00;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ffa500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
        }
        
        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .tab.active {
            background: linear-gradient(135deg, #ff6600, #ff8c00);
            border-color: #ff6600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Cartes de s√©lection de r√¥le */
        .role-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            border: 2px solid rgba(255,102,0,0.3);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .role-card:hover {
            background: rgba(255,102,0,0.2);
            border-color: #ff6600;
            transform: translateX(5px);
        }
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 18px; }
            .stat-card .number { font-size: 28px; }
            th, td { padding: 10px 5px; font-size: 14px; }
            .btn { padding: 10px 16px; font-size: 14px; }
            
            .header-top {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .logo-pc56 {
                height: 50px !important;
            }
            
            .quantity-number {
                font-size: 32px;
                min-width: 60px;
            }
            
            .btn-quick-remove {
                font-size: 28px;
                padding: 12px 18px;
            }
            
            .item-name-mobile {
                font-size: 16px;
            }
            
            /* Masquer certaines colonnes sur mobile */
            .hide-mobile {
                display: none;
            }
        }
    </style>
</head>
<body>

    <!-- Modal Connexion -->
    <div class="modal active" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîê Connexion - Protection Civile 56</h2>
            </div>
            <div class="form-group">
                <label>Identifiant :</label>
                <input type="text" id="loginUsername" placeholder="admin, valentine, etc.">
            </div>
            <div class="form-group">
                <label>Mot de passe :</label>
                <input type="password" id="loginPassword" placeholder="Mot de passe">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="login()">‚úÖ Se connecter</button>
            <div id="loginError" style="color: #ff4444; margin-top: 10px; text-align: center;"></div>
        </div>
    </div>

    <!-- Modal S√©lection de r√¥le -->
    <div class="modal" id="roleSelectorModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üë• S√©lectionnez votre r√¥le</h2>
            </div>
            <div id="rolesList"></div>
        </div>
    </div>

    <!-- Interface principale -->
    <div class="container" id="mainApp" style="display: none;">
        
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" alt="Logo PC56" class="logo-pc56" id="logoPc56" style="height: 60px; border-radius: 10px;">
                    <div>
                        <h1>üöë Inventaire Protection Civile 56</h1>
                        <p id="currentSiteName">Tous les sites</p>
                    </div>
                </div>
                <div class="user-info">
                    <div>üë§ <span id="currentUserDisplay"></span></div>
                    <div><span class="badge" id="currentUserBadge"></span></div>
                    <div id="currentUserSiteDisplay"></div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                        <span id="syncIndicator">üîÑ Synchronis√©</span>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px;" onclick="logout()">üö™ D√©connexion</button>
                </div>
            </div>
        </div>

        <!-- Tabs pour les sites (admin uniquement) -->
        <div class="tabs" id="siteTabs" style="display: none;">
            <div class="tab active" onclick="switchSite('all')">üìã Tous les sites</div>
            <div class="tab" onclick="switchSite('maraude')">üè† Maraude</div>
            <div class="tab" onclick="switchSite('stave')">üè• Saint Av√©</div>
            <div class="tab" onclick="switchSite('portlouis')">‚öì Port Louis</div>
        </div>

        <!-- Stats -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-card green">
                <h3>Articles total</h3>
                <div class="number" id="statTotal">0</div>
            </div>
            <div class="stat-card blue">
                <h3>En stock</h3>
                <div class="number" id="statInStock">0</div>
            </div>
            <div class="stat-card orange">
                <h3>Stock bas</h3>
                <div class="number" id="statLowStock">0</div>
            </div>
            <div class="stat-card red">
                <h3>Rupture</h3>
                <div class="number" id="statOutOfStock">0</div>
            </div>
        </div>

        <!-- Contr√¥les -->
        <div class="controls">
            <h3 style="margin-bottom: 15px;">‚öôÔ∏è Actions</h3>
            
            <!-- Actions admin/chef de poste -->
            <div class="controls-row" id="adminControls" style="display: none;">
                <button class="btn btn-success" onclick="showAddItemModal()">‚ûï Ajouter article</button>
                <button class="btn btn-info" onclick="showManageUsersModal()">üë• G√©rer utilisateurs</button>
                <button class="btn btn-info" onclick="exportInventory()">üíæ Export inventaire</button>
                <button class="btn btn-info" onclick="exportLogs()">üìã Export logs</button>
                <button class="btn btn-warning" onclick="manualRefresh()" title="Forcer la synchronisation">üîÑ Synchroniser</button>
            </div>
            
            <!-- Actions chef de bin√¥me -->
            <div class="controls-row" id="binomeControls" style="display: none;">
                <button class="btn btn-success" onclick="showTakeMaterialModal()">üì¶ Choisir mon sac</button>
                <button class="btn btn-primary" onclick="showTakeArticleModal()">üì• Prendre un article</button>
                <button class="btn btn-warning" onclick="manualRefresh()" title="Forcer la synchronisation">üîÑ Synchroniser</button>
            </div>
            
            <!-- Filtre -->
            <div class="controls-row">
                <input type="text" id="searchInput" placeholder="üîç Rechercher..." oninput="filterTable()">
                <select id="filterStatus" onchange="filterTable()">
                    <option value="all">Tous les statuts</option>
                    <option value="ok">En stock</option>
                    <option value="low">Stock bas</option>
                    <option value="out">Rupture</option>
                </select>
            </div>
        </div>

        <!-- Tableau principal -->
        <div class="table-container">
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th>Article</th>
                        <th>Site</th>
                        <th>Quantit√©</th>
                        <th>Seuil min</th>
                        <th>Type</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            Chargement...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <!-- Modal Ajouter Article -->
    <div class="modal" id="addItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="itemModalTitle">‚ûï Ajouter un article</h2>
                <span class="close" onclick="closeModal('addItemModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Nom de l'article :</label>
                <input type="text" id="itemName" placeholder="Ex: Compresses">
            </div>
            <div class="form-group">
                <label>Site :</label>
                <select id="itemSite">
                    <option value="maraude">Maraude</option>
                    <option value="stave">Saint Av√©</option>
                    <option value="portlouis">Port Louis</option>
                </select>
            </div>
            <div class="form-group" id="itemContainerGroup">
                <label>Conteneur (optionnel) :</label>
                <select id="itemContainer">
                    <option value="">Stock libre (√©tag√®re)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Quantit√© :</label>
                <input type="number" id="itemQuantity" value="0" min="0">
            </div>
            <div class="form-group">
                <label>Seuil minimum :</label>
                <input type="number" id="itemMinThreshold" value="5" min="0">
            </div>
            <div class="form-group">
                <label>Type :</label>
                <select id="itemType">
                    <option value="consommable">Consommable</option>
                    <option value="retournable">Retournable</option>
                </select>
            </div>
            <div class="form-group">
                <label>Cat√©gorie :</label>
                <select id="itemCategory">
                    <option value="medical">M√©dical</option>
                    <option value="alimentaire">Alimentaire</option>
                    <option value="hygiene">Hygi√®ne</option>
                    <option value="equipement">√âquipement</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="saveItem()">üíæ Enregistrer</button>
        </div>
    </div>

    <!-- Modal Modifier Article -->
    <div class="modal" id="editItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Modifier l'article</h2>
                <span class="close" onclick="closeModal('editItemModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Article : <strong id="editItemName">-</strong></label>
            </div>
            <div class="form-group">
                <label>Quantit√© actuelle : <strong id="editCurrentQty">0</strong></label>
            </div>
            <div class="form-group">
                <label>Action :</label>
                <select id="editAction" onchange="updateEditQuantityLabel()">
                    <option value="add">Ajouter</option>
                    <option value="remove">Retirer</option>
                    <option value="set">D√©finir</option>
                </select>
            </div>
            <div class="form-group">
                <label id="editQuantityLabel">Quantit√© √† ajouter :</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-secondary" onclick="decrementEditQuantity()" style="width: 50px; padding: 10px;">‚ûñ</button>
                    <input type="number" id="editQuantity" value="1" min="0" style="flex: 1;">
                    <button class="btn btn-secondary" onclick="incrementEditQuantity()" style="width: 50px; padding: 10px;">‚ûï</button>
                </div>
            </div>
            <div class="form-group">
                <label>Commentaire :</label>
                <textarea id="editComment" placeholder="Raison de la modification..." rows="3"></textarea>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="updateItem()">üíæ Valider</button>
        </div>
    </div>

    <!-- Modal Prendre mat√©riel (chef de bin√¥me) -->
    <div class="modal" id="takeMaterialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Prendre du mat√©riel</h2>
                <span class="close" onclick="closeModal('takeMaterialModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>üéí Choisir votre sac/conteneur :</label>
                <select id="takeContainerSelect" onchange="updateTakeContainerInventory()">
                    <option value="">-- S√©lectionnez votre sac --</option>
                </select>
            </div>
            <div id="takeContainerInventory" style="display: none;">
                <h3 style="margin: 20px 0 10px 0; color: #ff6600;">Inventaire du conteneur :</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Article</th>
                                <th>Quantit√©</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody id="takeContainerInventoryBody">
                            <tr><td colspan="3" style="text-align: center;">Choisissez un sac</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Prendre un article (chef de bin√¥me) -->
    <div class="modal" id="takeArticleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì• Prendre un article existant</h2>
                <span class="close" onclick="closeModal('takeArticleModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>üì¶ Article disponible sur le site :</label>
                <select id="takeArticleSelect" onchange="updateTakeArticleInfo()">
                    <option value="">-- Choisir un article --</option>
                </select>
            </div>
            <div id="takeArticleInfo" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                <p>Stock total site : <strong id="takeArticleTotalStock">0</strong></p>
                <p>Type : <strong id="takeArticleType">-</strong></p>
            </div>
            <div class="form-group">
                <label>Quantit√© √† prendre :</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-secondary" onclick="decrementTakeArticleQty()" style="width: 50px; padding: 10px;">‚ûñ</button>
                    <input type="number" id="takeArticleQuantity" value="1" min="1" style="flex: 1;">
                    <button class="btn btn-secondary" onclick="incrementTakeArticleQty()" style="width: 50px; padding: 10px;">‚ûï</button>
                </div>
            </div>
            <div class="form-group">
                <label>üì¶ Prendre depuis :</label>
                <select id="takeArticleSource">
                    <option value="">-- Choisir la source --</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="confirmTakeArticle()">‚úÖ Prendre</button>
        </div>
    </div>

    <!-- Modal Mon mat√©riel (chef de bin√¥me) -->
    <div class="modal" id="myMaterialModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üéí Mon mat√©riel</h2>
                <span class="close" onclick="closeModal('myMaterialModal')">&times;</span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Article</th>
                            <th>Quantit√©</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="myMaterialBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px;">
                                Aucun mat√©riel pris
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal G√©rer utilisateurs -->
    <div class="modal" id="manageUsersModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üë• Gestion des utilisateurs</h2>
                <span class="close" onclick="closeModal('manageUsersModal')">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="showAddUserModal()">‚ûï Ajouter utilisateur</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Pr√©nom</th>
                            <th>Grade</th>
                            <th>Site affect√©</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px;">
                                Chargement...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Ajouter/Modifier Utilisateur -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">‚ûï Ajouter utilisateur</h2>
                <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Pr√©nom :</label>
                <input type="text" id="userFirstname" placeholder="Pr√©nom">
            </div>
            <div class="form-group">
                <label>Mot de passe :</label>
                <input type="password" id="userPassword" placeholder="Minimum 4 caract√®res">
            </div>
            <div class="form-group">
                <label>Grade :</label>
                <select id="userGrade">
                    <option value="chef-binome">Chef de bin√¥me</option>
                    <option value="chef-equipe">Chef d'√©quipe</option>
                    <option value="chef-poste">Chef de poste</option>
                </select>
            </div>
            <div class="form-group" id="userSiteGroup">
                <label>Site affect√© (pour chef de poste) :</label>
                <select id="userSite">
                    <option value="">-- Aucun --</option>
                    <option value="maraude">Maraude</option>
                    <option value="stave">Saint Av√©</option>
                    <option value="portlouis">Port Louis</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="saveUser()">üíæ Enregistrer</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <script>
        // ============================================================================
        // CONFIGURATION SUPABASE
        // ============================================================================
        
        const SUPABASE_URL = 'https://hnmftuipbpcfavtotfaf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhubWZ0dWlwYnBjZmF2dG90ZmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNzgxMDUsImV4cCI6MjA4NjY1NDEwNX0.JRHkP5eTvBcnCNsLCvjo9EBh3lDQoeTLj6-9Vimk39M';
        
        // Cr√©er le client Supabase
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ============================================================================
        // VARIABLES GLOBALES
        // ============================================================================
        
        let currentUser = null;
        let currentUserRole = null;
        let currentUserSite = null;
        let currentSiteFilter = 'all';
        let currentEditItemId = null;
        let currentEditUserId = null;
        
        let inventory = [];
        let users = {};
        let logs = [];
        let userInventories = {}; // Pour les mat√©riels des chefs de bin√¥me
        let containers = []; // Conteneurs (sacs et tours)
        let userRoles = []; // Multi-r√¥les pour l'utilisateur connect√©
        let currentRole = null; // R√¥le s√©lectionn√© pour la session
        let selectedContainerId = null; // Conteneur s√©lectionn√© par le chef de bin√¥me
        
        // Auto-refresh pour synchronisation temps r√©el
        let autoRefreshInterval = null;
        
        // ============================================================================
        // INITIALISATION
        // ============================================================================
        
        async function init() {
            await loadData();
            
            // Charger le logo
            loadLogo();
            
            // Tenter une connexion automatique
            const loggedIn = await autoLogin();
            
            // Gestion de la touche Entr√©e
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        }
        
        function loadLogo() {
            // Le logo sera charg√© depuis le d√©p√¥t GitHub
            // Pour l'instant, on utilise un placeholder
            const logo = document.getElementById('logoPc56');
            if (logo) {
                // Essayer de charger depuis GitHub
                logo.src = 'https://raw.githubusercontent.com/LeBodicStephane/protec56/main/logo.png';
                logo.onerror = function() {
                    // Si erreur, masquer le logo
                    this.style.display = 'none';
                };
            }
        }
        
        async function loadData() {
            // Charger tous les utilisateurs depuis Supabase
            await loadAllUsers();
            
            // Charger les conteneurs depuis Supabase
            await loadContainers();
            
            // Charger l'inventaire depuis Supabase
            await loadInventory();
            
            // Charger les logs depuis Supabase
            await loadLogs();
            
            // Charger les inventaires utilisateurs depuis Supabase
            await loadUserInventories();
        }
        
        async function loadAllUsers() {
            try {
                const { data, error } = await db
                    .from('users')
                    .select('*');
                
                if (error) {
                    console.error('Erreur Supabase users:', error.message, error);
                    throw error;
                }
                
                users = {};
                if (data) {
                    data.forEach(user => {
                        users[user.username] = {
                            password: user.password,
                            role: user.role,
                            firstname: user.firstname,
                            site: user.site
                        };
                    });
                }
            } catch (e) {
                console.error('Erreur chargement utilisateurs:', e.message || e);
                users = {};
            }
        }
        
        async function loadContainers() {
            try {
                const { data, error } = await db
                    .from('containers')
                    .select('*')
                    .eq('active', true)
                    .order('name', { ascending: true });
                
                if (error) throw error;
                
                containers = data || [];
            } catch (e) {
                console.error('Erreur chargement conteneurs:', e);
                containers = [];
            }
        }
        
        async function loadInventory() {
            try {
                // Utiliser la fonction s√©curis√©e qui filtre selon les permissions
                const { data, error } = await db.rpc('get_inventory', {
                    p_username: currentUser
                });
                
                if (error) throw error;
                
                inventory = data || [];
            } catch (e) {
                console.error('Erreur chargement inventaire:', e);
                inventory = [];
            }
        }
        
        async function saveInventory() {
            // Avec Supabase, les modifications sont d√©j√† sauvegard√©es individuellement
            // Cette fonction reste pour compatibilit√© mais ne fait rien
            return true;
        }
        
        async function loadLogs() {
            try {
                const { data, error } = await db
                    .from('logs')
                    .select('*')
                    .order('timestamp', { ascending: false });
                
                if (error) throw error;
                
                logs = data || [];
            } catch (e) {
                console.error('Erreur chargement logs:', e);
                logs = [];
            }
        }
        
        async function saveLogs() {
            // Les logs sont sauvegard√©s individuellement, pas besoin de tout sauvegarder
            return true;
        }
        
        async function loadUserInventories() {
            try {
                const { data, error } = await db
                    .from('user_inventories')
                    .select('*');
                
                if (error) throw error;
                
                userInventories = {};
                if (data) {
                    data.forEach(item => {
                        if (!userInventories[item.username]) {
                            userInventories[item.username] = [];
                        }
                        userInventories[item.username].push({
                            id: item.id,
                            itemId: item.item_id,
                            itemName: item.item_name,
                            quantity: item.quantity,
                            type: item.type,
                            site: item.site
                        });
                    });
                }
            } catch (e) {
                console.error('Erreur chargement inventaires utilisateurs:', e);
                userInventories = {};
            }
        }
        
        async function saveUserInventories() {
            // Les inventaires sont sauvegard√©s individuellement
            return true;
        }
        
        async function addLog(action, description) {
            const logEntry = {
                username: currentUser,
                action: action,
                description: description,
                timestamp: new Date().toISOString()
            };
            
            // Ajouter localement
            logs.unshift(logEntry);
            
            // Sauvegarder dans Supabase
            try {
                const { error } = await db
                    .from('logs')
                    .insert([logEntry]);
                
                if (error) throw error;
            } catch (e) {
                console.error('Erreur sauvegarde log:', e);
            }
        }
        
        function getCurrentUserData() {
            return accounts[currentUser] || users[currentUser];
        }
        
        function getMinThreshold(item) {
            return item.min_threshold || item.minThreshold || 5;
        }
        
        // ============================================================================
        // AUTHENTIFICATION
        // ============================================================================
        
        // Comptes en dur
        const accounts = {
            'admin': {
                password: 'admin2025',
                role: 'admin',
                firstname: 'Administrateur',
                site: null
            },
            'valentine': {
                password: 'valentine',
                role: 'chef-poste',
                firstname: 'Valentine',
                site: 'maraude'
            }
        };
        
        async function login() {
            const username = document.getElementById('loginUsername').value.toLowerCase().trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!username || !password) {
                document.getElementById('loginError').textContent = '‚ö†Ô∏è Veuillez remplir tous les champs';
                return;
            }
            
            // NOUVELLE M√âTHODE S√âCURIS√âE : Utiliser la fonction Supabase
            console.log('üîí Connexion s√©curis√©e via Supabase...');
            try {
                const { data, error } = await db.rpc('login_user', {
                    p_username: username,
                    p_password: password
                });
                
                console.log('üîí R√©sultat login_user:', data);
                
                if (error) {
                    console.error('üîí Erreur Supabase:', error);
                    document.getElementById('loginError').textContent = '‚ùå Erreur de connexion';
                    return;
                }
                
                // Si la fonction retourne success = false
                if (!data || data.length === 0 || !data[0].success) {
                    document.getElementById('loginError').textContent = '‚ùå Identifiants incorrects';
                    return;
                }
                
                // Connexion r√©ussie !
                console.log('‚úÖ Connexion r√©ussie pour', username);
                currentUser = username;
                await loadUserRolesAndLogin(username);
                
            } catch (e) {
                console.error('üîí Exception:', e);
                document.getElementById('loginError').textContent = '‚ùå Erreur technique';
            }
        }
        
        async function loadUserRolesAndLogin(username) {
            try {
                // Charger tous les r√¥les de l'utilisateur depuis user_roles
                const { data, error } = await db
                    .from('user_roles')
                    .select('*, containers(id, name, type, parent_site)')
                    .eq('username', username);
                
                // Si la table user_roles n'existe pas encore, utiliser l'ancien syst√®me
                if (error && error.message.includes('does not exist')) {
                    console.log('Table user_roles non trouv√©e, utilisation du syst√®me legacy');
                    legacyLogin(username);
                    return;
                }
                
                if (error) throw error;
                
                userRoles = data || [];
                
                if (userRoles.length === 0) {
                    // Pas de r√¥les dans user_roles, essayer le syst√®me legacy
                    console.log('Aucun r√¥le dans user_roles, utilisation du syst√®me legacy');
                    legacyLogin(username);
                    return;
                }
                
                if (userRoles.length === 1) {
                    // Un seul r√¥le : connexion directe
                    selectRoleAndLogin(userRoles[0]);
                } else {
                    // Plusieurs r√¥les : afficher le s√©lecteur
                    showRoleSelector();
                }
            } catch (e) {
                console.error('Erreur chargement r√¥les:', e);
                // En cas d'erreur, essayer le syst√®me legacy
                console.log('Erreur, utilisation du syst√®me legacy');
                legacyLogin(username);
            }
        }
        
        async function legacyLogin(username) {
            // Utiliser l'ancienne m√©thode avec la table users
            const user = accounts[username] || users[username];
            if (!user) {
                document.getElementById('loginError').textContent = '‚ùå Utilisateur non trouv√©';
                return;
            }
            
            currentUserRole = user.role;
            currentUserSite = user.site || null;
            currentRole = {
                role_type: user.role,
                site: user.site,
                container_id: null
            };
            
            // Sauvegarder dans localStorage
            localStorage.setItem('pc56_current_user', username);
            
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';
            
            updateUserDisplay();
            initInterface();
            await autoSync(); // Synchronisation automatique apr√®s connexion
            
            addLog('Connexion', user.firstname + ' s\'est connect√©');
        }
        
        function showRoleSelector() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('roleSelectorModal').classList.add('active');
            
            const rolesList = document.getElementById('rolesList');
            rolesList.innerHTML = '';
            
            userRoles.forEach(role => {
                const roleCard = document.createElement('div');
                roleCard.className = 'role-card';
                roleCard.onclick = () => selectRoleAndLogin(role);
                
                let roleLabel = '';
                let roleDesc = '';
                
                switch(role.role_type) {
                    case 'admin':
                        roleLabel = 'üëë Administrateur';
                        roleDesc = 'Gestion compl√®te de tous les sites';
                        break;
                    case 'chef-poste':
                        roleLabel = 'üéñÔ∏è Chef de poste - ' + role.site.toUpperCase();
                        roleDesc = 'Gestion du site ' + role.site;
                        break;
                    case 'chef-equipe':
                        roleLabel = '‚≠ê Chef d\'√©quipe - ' + role.site.toUpperCase();
                        roleDesc = 'Gestion d\'√©quipe sur ' + role.site;
                        break;
                    case 'chef-binome':
                        const containerName = role.containers ? role.containers.name : 'Conteneur';
                        roleLabel = 'üë• Chef de bin√¥me - ' + containerName;
                        roleDesc = 'Gestion du conteneur ' + containerName;
                        break;
                }
                
                roleCard.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">${roleLabel}</div>
                    <div style="font-size: 14px; opacity: 0.8;">${roleDesc}</div>
                `;
                
                rolesList.appendChild(roleCard);
            });
        }
        
        function selectRoleAndLogin(role) {
            currentRole = role;
            currentUserRole = role.role_type;
            currentUserSite = role.site || null;
            
            // Sauvegarder dans localStorage
            localStorage.setItem('pc56_current_user', currentUser);
            localStorage.setItem('pc56_current_role', JSON.stringify(role));
            
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('roleSelectorModal').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';
            
            updateUserDisplay();
            initInterface();
            updateStats();
            displayInventory();
            
            const userData = getCurrentUserData();
            addLog('Connexion', userData.firstname + ' s\'est connect√© en tant que ' + currentUserRole);
            
            // Auto-refresh supprim√© - utiliser le bouton "Synchroniser" manuellement
        }
        
        function startAutoRefresh() {
            // Arr√™ter l'ancien interval si existant
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            console.log('üîÑ Auto-refresh d√©marr√© (toutes les 3 secondes)');
            
            // Rafra√Æchir toutes les 3 secondes
            autoRefreshInterval = setInterval(async function() {
                console.log('üîÑ Synchronisation en cours...', new Date().toLocaleTimeString());
                const indicator = document.getElementById('syncIndicator');
                if (indicator) indicator.textContent = 'üîÑ Synchronisation...';
                
                await loadInventory();
                await loadContainers();
                displayInventory();
                updateStats();
                
                console.log('‚úÖ Synchronisation termin√©e, inventory.length =', inventory.length);
                
                if (indicator) {
                    indicator.textContent = '‚úÖ Synchronis√©';
                    setTimeout(() => {
                        if (indicator) indicator.textContent = 'üîÑ Synchronis√©';
                    }, 1000);
                }
            }, 3000); // 3 secondes au lieu de 5
        }
        
        // Fonction de synchronisation automatique apr√®s chaque action
        async function autoSync() {
            console.log('üîÑ Auto-synchronisation...');
            await loadInventory();
            await loadContainers();
            displayInventory();
            updateStats();
        }
        
        async function manualRefresh() {
            console.log('üîÑ Synchronisation MANUELLE d√©clench√©e');
            const indicator = document.getElementById('syncIndicator');
            if (indicator) indicator.textContent = 'üîÑ Synchronisation...';
            
            // Charger les donn√©es
            await loadInventory();
            await loadContainers();
            displayInventory();
            updateStats();
            
            console.log('‚úÖ Synchronisation manuelle termin√©e, inventory.length =', inventory.length);
            
            if (indicator) {
                indicator.textContent = '‚úÖ Synchronis√©';
                setTimeout(() => {
                    if (indicator) indicator.textContent = '';
                }, 2000);
            }
            
            // AUTO-REFRESH SUPPRIM√â : Ne plus red√©marrer automatiquement
            // Les utilisateurs doivent cliquer manuellement pour synchroniser
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        async function logout() {
            if (!confirm('Voulez-vous vraiment vous d√©connexter ?')) return;
            
            await addLog('D√©connexion', users[currentUser]?.firstname || currentUser + ' s\'est d√©connect√©');
            
            // Arr√™ter l'auto-refresh
            stopAutoRefresh();
            
            currentUser = null;
            currentUserRole = null;
            currentUserSite = null;
            currentSiteFilter = 'all';
            currentRole = null;
            userRoles = [];
            
            localStorage.removeItem('pc56_current_user');
            localStorage.removeItem('pc56_current_role');
            
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').textContent = '';
        }
        
        async function autoLogin() {
            const savedUser = localStorage.getItem('pc56_current_user');
            if (savedUser) {
                // V√©rifier dans les comptes en dur
                if (accounts[savedUser]) {
                    currentUser = savedUser;
                    currentUserRole = accounts[savedUser].role;
                    currentUserSite = accounts[savedUser].site || null;
                    
                    document.getElementById('loginModal').classList.remove('active');
                    document.getElementById('mainApp').style.display = 'block';
                    
                    updateUserDisplay();
                    initInterface();
                    updateStats();
                    displayInventory();
                    return true;
                }
                
                // Sinon v√©rifier dans les utilisateurs
                if (users[savedUser]) {
                    currentUser = savedUser;
                    currentUserRole = users[savedUser].role;
                    currentUserSite = users[savedUser].site || null;
                    
                    document.getElementById('loginModal').classList.remove('active');
                    document.getElementById('mainApp').style.display = 'block';
                    
                    updateUserDisplay();
                    initInterface();
                    updateStats();
                    displayInventory();
                    return true;
                }
            }
            return false;
        }
        
        // ============================================================================
        // INTERFACE
        // ============================================================================
        
        function updateUserDisplay() {
            // Chercher l'utilisateur dans les comptes en dur ou dans users
            const user = accounts[currentUser] || users[currentUser];
            if (!user) return;
            
            document.getElementById('currentUserDisplay').textContent = user.firstname;
            
            const badge = document.getElementById('currentUserBadge');
            badge.className = 'badge badge-' + currentUserRole.replace('-', '');
            
            const roleNames = {
                'admin': 'Administrateur',
                'chef-poste': 'Chef de poste',
                'chef-equipe': 'Chef d\'√©quipe',
                'chef-binome': 'Chef de bin√¥me'
            };
            badge.textContent = roleNames[currentUserRole] || currentUserRole;
            
            // Afficher le site si chef de poste
            const siteDisplay = document.getElementById('currentUserSiteDisplay');
            if (currentUserSite) {
                const siteNames = {
                    'maraude': 'Maraude',
                    'stave': 'Saint Av√©',
                    'portlouis': 'Port Louis'
                };
                siteDisplay.textContent = 'üìç ' + siteNames[currentUserSite];
                siteDisplay.style.display = 'block';
            } else {
                siteDisplay.style.display = 'none';
            }
        }
        
        function initInterface() {
            // Afficher les tabs pour l'admin uniquement
            if (currentUserRole === 'admin') {
                document.getElementById('siteTabs').style.display = 'flex';
                document.getElementById('adminControls').style.display = 'flex';
                document.getElementById('binomeControls').style.display = 'none';
            } else if (currentUserRole === 'chef-poste') {
                document.getElementById('siteTabs').style.display = 'none';
                document.getElementById('adminControls').style.display = 'flex';
                document.getElementById('binomeControls').style.display = 'none';
                // Filtrer automatiquement sur le site du chef de poste
                currentSiteFilter = currentUserSite;
                updateSiteName();
            } else if (currentUserRole === 'chef-binome') {
                document.getElementById('siteTabs').style.display = 'none';
                document.getElementById('adminControls').style.display = 'none';
                document.getElementById('binomeControls').style.display = 'flex';
                currentSiteFilter = 'all';
            } else {
                document.getElementById('siteTabs').style.display = 'none';
                document.getElementById('adminControls').style.display = 'none';
                document.getElementById('binomeControls').style.display = 'none';
            }
        }
        
        function switchSite(site) {
            currentSiteFilter = site;
            
            // Mettre √† jour les tabs
            const tabs = document.querySelectorAll('.tabs .tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            if (site === 'all') tabs[0].classList.add('active');
            else if (site === 'maraude') tabs[1].classList.add('active');
            else if (site === 'stave') tabs[2].classList.add('active');
            else if (site === 'portlouis') tabs[3].classList.add('active');
            
            updateSiteName();
            updateStats();
            displayInventory();
        }
        
        function updateSiteName() {
            const siteNames = {
                'all': 'Tous les sites',
                'maraude': 'üè† Maraude',
                'stave': 'üè• Saint Av√©',
                'portlouis': '‚öì Port Louis'
            };
            document.getElementById('currentSiteName').textContent = siteNames[currentSiteFilter] || 'Tous les sites';
        }
        
        function updateStats() {
            // Si chef de bin√¥me sans conteneur, masquer les stats
            if (currentUserRole === 'chef-binome' && !selectedContainerId) {
                document.getElementById('statTotal').textContent = '-';
                document.getElementById('statInStock').textContent = '-';
                document.getElementById('statLowStock').textContent = '-';
                document.getElementById('statOutOfStock').textContent = '-';
                return;
            }
            
            const filtered = getFilteredInventory();
            
            const total = filtered.length;
            const inStock = filtered.filter(item => item.quantity > getMinThreshold(item)).length;
            const lowStock = filtered.filter(item => item.quantity > 0 && item.quantity <= getMinThreshold(item)).length;
            const outOfStock = filtered.filter(item => item.quantity === 0).length;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statInStock').textContent = inStock;
            document.getElementById('statLowStock').textContent = lowStock;
            document.getElementById('statOutOfStock').textContent = outOfStock;
        }
        
        function getFilteredInventory() {
            let filtered = inventory;
            
            // Filtrer selon le r√¥le
            if (currentUserRole === 'chef-binome' && selectedContainerId) {
                // Chef de bin√¥me : voir le conteneur qu'il a s√©lectionn√©
                filtered = filtered.filter(item => item.container_id === selectedContainerId);
            } else if (currentUserRole === 'chef-binome' && currentRole && currentRole.container_id) {
                // Chef de bin√¥me : voir son conteneur par d√©faut s'il n'a rien s√©lectionn√©
                filtered = filtered.filter(item => item.container_id === currentRole.container_id);
            } else if (currentUserRole === 'chef-poste' && currentUserSite) {
                // Chef de poste : voir son site (avec et sans conteneurs)
                filtered = filtered.filter(item => item.site === currentUserSite);
            } else if (currentSiteFilter !== 'all') {
                // Filtre manuel par site
                filtered = filtered.filter(item => item.site === currentSiteFilter);
            }
            
            return filtered;
        }
        
        function displayInventory() {
            const tbody = document.getElementById('inventoryBody');
            
            // Si chef de bin√¥me sans conteneur s√©lectionn√©, afficher un message
            if (currentUserRole === 'chef-binome' && !selectedContainerId) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 60px;">
                            <div style="font-size: 24px; margin-bottom: 20px;">üì¶</div>
                            <div style="font-size: 18px; margin-bottom: 20px;">Veuillez d'abord choisir votre sac</div>
                            <button class="btn btn-success" onclick="showTakeMaterialModal()" style="padding: 15px 30px; font-size: 16px;">
                                üì¶ Choisir mon sac
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let filtered = getFilteredInventory();
            
            // Appliquer les filtres de recherche et statut
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter === 'ok') {
                filtered = filtered.filter(item => item.quantity > getMinThreshold(item));
            } else if (statusFilter === 'low') {
                filtered = filtered.filter(item => item.quantity > 0 && item.quantity <= getMinThreshold(item));
            } else if (statusFilter === 'out') {
                filtered = filtered.filter(item => item.quantity === 0);
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">Aucun article</td></tr>';
                return;
            }
            
            let html = '';
            filtered.forEach(item => {
                const status = item.quantity === 0 ? 'critical' : 
                               item.quantity <= getMinThreshold(item) ? 'low' : 'ok';
                
                const statusText = item.quantity === 0 ? '‚ùå Rupture' :
                                  item.quantity <= getMinThreshold(item) ? '‚ö†Ô∏è Stock bas' : '‚úÖ En stock';
                
                const siteNames = {
                    'maraude': 'Maraude',
                    'stave': 'Saint Av√©',
                    'portlouis': 'Port Louis'
                };
                
                // Affichage selon le type de vue
                let locationText = siteNames[item.site];
                if (item.isGlobal) {
                    locationText += ' (STOCK GLOBAL)';
                } else if (item.container_id) {
                    const container = containers.find(c => c.id === item.container_id);
                    if (container) {
                        locationText += ` - ${container.name}`;
                    }
                }
                
                const typeText = item.type === 'retournable' ? 'üîÑ' : 'üì¶';
                
                // Classe pour mettre en surbrillance les stocks bas/critiques
                const rowClass = item.quantity === 0 ? 'stock-critical' : 
                                item.quantity <= getMinThreshold(item) ? 'stock-alert' : '';
                
                // Bouton - rapide pour admin, chef de poste ET chef de bin√¥me
                let quickRemoveBtn = '';
                if ((currentUserRole === 'admin' || currentUserRole === 'chef-poste' || currentUserRole === 'chef-binome') && item.quantity > 0 && item.type === 'consommable') {
                    quickRemoveBtn = `<button class="btn-quick-remove" onclick="quickRemoveOne(${item.id})" title="Retirer 1">‚ûñ</button>`;
                }
                
                // Afficher les actions selon le r√¥le
                let actions = '';
                if (currentUserRole === 'admin' || currentUserRole === 'chef-poste' || currentUserRole === 'chef-binome') {
                    actions = `
                        <button class="btn btn-sm btn-info" onclick="showEditItemModal(${item.id})" title="Modifier">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})" title="Supprimer">üóëÔ∏è</button>
                    `;
                }
                
                html += `
                    <tr class="${rowClass}">
                        <td class="item-name-mobile"><strong>${item.name}</strong></td>
                        <td class="hide-mobile">${locationText}</td>
                        <td>
                            <div class="quantity-display">
                                <span class="quantity-number" onclick="quickEditQuantity(${item.id}, ${item.quantity})" title="Cliquer pour modifier">${item.quantity}</span>
                                ${quickRemoveBtn}
                            </div>
                        </td>
                        <td class="hide-mobile">${getMinThreshold(item)}</td>
                        <td class="hide-mobile" title="${item.type === 'retournable' ? 'Retournable' : 'Consommable'}">${typeText}</td>
                        <td class="status-${status}">${statusText}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function filterTable() {
            displayInventory();
        }
        
        // ============================================================================
        // FONCTIONS RAPIDES POUR MOBILE
        // ============================================================================
        
        async function quickRemoveOne(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item || item.quantity <= 0) return;
            
            const oldQty = item.quantity;
            item.quantity -= 1;
            
            // Mettre √† jour via la fonction s√©curis√©e
            try {
                const { data, error } = await db.rpc('update_inventory_item', {
                    p_username: currentUser,
                    p_item_id: itemId,
                    p_quantity: item.quantity
                });
                
                if (error) throw error;
            } catch (e) {
                console.error('Erreur mise √† jour stock:', e);
                item.quantity = oldQty;
                alert('‚ö†Ô∏è Erreur lors de la mise √† jour: ' + (e.message || 'Permission refus√©e'));
                return;
            }
            
            await addLog('Retrait rapide', getCurrentUserData().firstname + ' a retir√© 1x ' + item.name + ' (' + oldQty + ' ‚Üí ' + item.quantity + ')');
            
            // V√©rifier le seuil
            const minThreshold = getMinThreshold(item);
            if (item.quantity <= minThreshold && item.quantity > 0) {
                const siteNames = {
                    'maraude': 'Maraude',
                    'stave': 'Saint Av√©',
                    'portlouis': 'Port Louis'
                };
                await addLog('‚ö†Ô∏è Alerte stock', 'Stock bas pour ' + item.name + ' (' + item.quantity + '/' + minThreshold + ') sur ' + siteNames[item.site]);
            } else if (item.quantity === 0) {
                const siteNames = {
                    'maraude': 'Maraude',
                    'stave': 'Saint Av√©',
                    'portlouis': 'Port Louis'
                };
                await addLog('‚ùå Rupture stock', 'Rupture de stock pour ' + item.name + ' sur ' + siteNames[item.site]);
            }
            
            await autoSync(); // Synchronisation automatique
        }
        
        function quickEditQuantity(itemId, currentQty) {
            const newQty = prompt('Nouvelle quantit√© :', currentQty);
            if (newQty === null || newQty === '') return;
            
            const qty = parseInt(newQty);
            if (isNaN(qty) || qty < 0) {
                alert('‚ö†Ô∏è Quantit√© invalide');
                return;
            }
            
            // Simuler un clic sur modifier avec la quantit√© d√©finie
            currentEditItemId = itemId;
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;
            
            updateItemQuantityDirect(itemId, qty);
        }
        
        async function updateItemQuantityDirect(itemId, newQty) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;
            
            const oldQty = item.quantity;
            item.quantity = newQty;
            
            // Mettre √† jour via la fonction s√©curis√©e
            try {
                const { data, error } = await db.rpc('update_inventory_item', {
                    p_username: currentUser,
                    p_item_id: itemId,
                    p_quantity: newQty
                });
                
                if (error) throw error;
            } catch (e) {
                console.error('Erreur mise √† jour stock:', e);
                item.quantity = oldQty;
                alert('‚ö†Ô∏è Erreur lors de la mise √† jour: ' + (e.message || 'Permission refus√©e'));
                return;
            }
            
            await addLog('Modification directe', getCurrentUserData().firstname + ' a modifi√© ' + item.name + ' : ' + oldQty + ' ‚Üí ' + newQty);
            
            await autoSync(); // Synchronisation automatique
        }
        
        // ============================================================================
        // GESTION ARTICLES
        // ============================================================================
        
        function showAddItemModal() {
            if (currentUserRole !== 'admin' && currentUserRole !== 'chef-poste' && currentUserRole !== 'chef-binome') {
                alert('‚ö†Ô∏è Action non autoris√©e');
                return;
            }
            
            console.log('üì¶ showAddItemModal - containers.length =', containers.length);
            console.log('üë§ currentUserRole =', currentUserRole);
            console.log('üéØ currentRole =', currentRole);
            
            document.getElementById('itemModalTitle').textContent = '‚ûï Ajouter un article';
            document.getElementById('itemName').value = '';
            document.getElementById('itemQuantity').value = 0;
            document.getElementById('itemMinThreshold').value = 5;
            document.getElementById('itemType').value = 'consommable';
            document.getElementById('itemCategory').value = 'medical';
            
            // Remplir le s√©lecteur de conteneur
            const containerSelect = document.getElementById('itemContainer');
            if (!containerSelect) {
                console.error('‚ùå itemContainer select not found!');
                return;
            }
            
            containerSelect.innerHTML = '<option value="">Stock libre (√©tag√®re)</option>';
            
            // Pr√©-s√©lectionner le site et les conteneurs
            if (currentUserRole === 'chef-poste') {
                document.getElementById('itemSite').value = currentUserSite;
                document.getElementById('itemSite').disabled = true;
                
                // Ajouter les conteneurs du site
                const siteContainers = containers.filter(c => c.parent_site === currentUserSite && c.active);
                console.log('üì¶ Chef de poste - siteContainers =', siteContainers.length);
                siteContainers.forEach(container => {
                    const option = document.createElement('option');
                    option.value = container.id;
                    option.textContent = container.name;
                    containerSelect.appendChild(option);
                });
                
            } else if (currentUserRole === 'chef-binome' && currentRole && currentRole.site) {
                document.getElementById('itemSite').value = currentRole.site;
                document.getElementById('itemSite').disabled = true;
                
                // Ajouter les conteneurs du site pour chef de bin√¥me
                const siteContainers = containers.filter(c => c.parent_site === currentRole.site && c.active);
                console.log('üì¶ Chef de bin√¥me - siteContainers =', siteContainers.length, 'site =', currentRole.site);
                siteContainers.forEach(container => {
                    const option = document.createElement('option');
                    option.value = container.id;
                    option.textContent = container.name;
                    containerSelect.appendChild(option);
                    console.log('  ‚úÖ Ajout√©:', container.name, 'id=', container.id);
                });
                
                // Pr√©-s√©lectionner son conteneur si d√©fini
                if (selectedContainerId) {
                    containerSelect.value = selectedContainerId;
                    console.log('üéØ Pr√©-s√©lectionn√© conteneur:', selectedContainerId);
                }
                
            } else {
                document.getElementById('itemSite').disabled = false;
                // Pour admin, montrer tous les conteneurs
                containers.filter(c => c.active).forEach(container => {
                    const option = document.createElement('option');
                    option.value = container.id;
                    option.textContent = container.name + ' (' + container.parent_site + ')';
                    containerSelect.appendChild(option);
                });
            }
            
            console.log('üì¶ Nombre d\'options dans le select:', containerSelect.options.length);
            
            currentEditItemId = null;
            openModal('addItemModal');
        }
        
        async function saveItem() {
            const name = document.getElementById('itemName').value.trim();
            const site = document.getElementById('itemSite').value;
            const containerSelect = document.getElementById('itemContainer');
            const containerId = containerSelect && containerSelect.value ? parseInt(containerSelect.value) : null;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 0;
            const minThreshold = parseInt(document.getElementById('itemMinThreshold').value) || 0;
            const type = document.getElementById('itemType').value;
            const category = document.getElementById('itemCategory').value;
            
            if (!name) {
                alert('‚ö†Ô∏è Veuillez entrer un nom d\'article');
                return;
            }
            
            if (currentEditItemId) {
                // Modification
                const item = inventory.find(i => i.id === currentEditItemId);
                if (item) {
                    item.name = name;
                    item.site = site;
                    item.quantity = quantity;
                    item.min_threshold = minThreshold;
                    item.type = type;
                    item.category = category;
                    
                    // Mettre √† jour via la fonction s√©curis√©e
                    try {
                        const { data, error } = await db.rpc('modify_inventory_item', {
                            p_username: currentUser,
                            p_item_id: currentEditItemId,
                            p_name: name,
                            p_site: site,
                            p_quantity: quantity,
                            p_min_threshold: minThreshold,
                            p_type: type,
                            p_category: category
                        });
                        
                        if (error) throw error;
                    } catch (e) {
                        console.error('Erreur modification article:', e);
                        alert('‚ö†Ô∏è Erreur lors de la modification: ' + (e.message || 'Permission refus√©e'));
                        return;
                    }
                    
                    await addLog('Modification', getCurrentUserData().firstname + ' a modifi√© l\'article ' + name);
                }
            } else {
                // Ajout via la fonction s√©curis√©e
                try {
                    const { data, error } = await db.rpc('create_inventory_item', {
                        p_username: currentUser,
                        p_name: name,
                        p_site: site,
                        p_container_id: containerId,
                        p_quantity: quantity,
                        p_min_threshold: minThreshold,
                        p_type: type,
                        p_category: category
                    });
                    
                    if (error) throw error;
                    
                    // Recharger l'inventaire pour avoir le nouvel article
                    await loadInventory();
                } catch (e) {
                    console.error('Erreur ajout article:', e);
                    alert('‚ö†Ô∏è Erreur lors de l\'ajout: ' + (e.message || 'Permission refus√©e'));
                    return;
                }
                
                const containerName = containerId ? 
                    containers.find(c => c.id === containerId)?.name || 'conteneur' : 
                    'stock libre';
                await addLog('Ajout', getCurrentUserData().firstname + ' a ajout√© ' + name + ' dans ' + containerName);
            }
            
            closeModal('addItemModal');
            await autoSync(); // Synchronisation automatique
        }
        
        function showEditItemModal(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;
            
            currentEditItemId = itemId;
            document.getElementById('editItemName').textContent = item.name;
            document.getElementById('editCurrentQty').textContent = item.quantity;
            document.getElementById('editAction').value = 'add';
            document.getElementById('editQuantity').value = 1;
            document.getElementById('editComment').value = '';
            
            // Si chef de bin√¥me et qu'on est dans un conteneur, cr√©er le s√©lecteur de source
            if (currentUserRole === 'chef-binome' && item.container_id) {
                // Cr√©er le s√©lecteur de source s'il n'existe pas
                let sourceGroup = document.getElementById('editSourceGroup');
                if (!sourceGroup) {
                    const editQuantityGroup = document.getElementById('editQuantity').parentElement.parentElement;
                    const sourceSelectorHTML = `
                        <div class="form-group" id="editSourceGroup">
                            <label>üì¶ Prendre depuis :</label>
                            <select id="editSourceContainer">
                                <option value="">-- Choisir la source --</option>
                            </select>
                        </div>
                    `;
                    editQuantityGroup.insertAdjacentHTML('afterend', sourceSelectorHTML);
                }
                
                // Remplir les sources disponibles
                updateSourceSelector(item);
                
                // G√©rer l'affichage du s√©lecteur selon l'action
                const editActionSelect = document.getElementById('editAction');
                const originalOnChange = editActionSelect.onchange;
                
                editActionSelect.onchange = function() {
                    const action = this.value;
                    const sourceGroup = document.getElementById('editSourceGroup');
                    if (sourceGroup) {
                        if (action === 'add' && currentUserRole === 'chef-binome' && item.container_id) {
                            sourceGroup.style.display = 'block';
                        } else {
                            sourceGroup.style.display = 'none';
                        }
                    }
                    updateEditQuantityLabel();
                };
                
                // Afficher le s√©lecteur d√®s maintenant (action = 'add' par d√©faut)
                sourceGroup = document.getElementById('editSourceGroup');
                if (sourceGroup) {
                    sourceGroup.style.display = 'block';
                }
            } else {
                // Masquer le s√©lecteur s'il existe
                const sourceGroup = document.getElementById('editSourceGroup');
                if (sourceGroup) {
                    sourceGroup.style.display = 'none';
                }
            }
            
            // Chef de bin√¥me a les m√™mes droits que chef de poste
            const isReadOnly = false;
            document.getElementById('editAction').disabled = isReadOnly;
            document.getElementById('editQuantity').disabled = isReadOnly;
            document.getElementById('editComment').disabled = isReadOnly;
            
            // Afficher le bouton de validation
            const validateBtn = document.querySelector('#editItemModal .btn-primary');
            if (validateBtn) {
                validateBtn.style.display = 'block';
            }
            
            updateEditQuantityLabel();
            openModal('editItemModal');
        }
        
        function updateSourceSelector(item) {
            console.log('üì¶ updateSourceSelector appel√©, item =', item);
            const sourceSelect = document.getElementById('editSourceContainer');
            console.log('üì¶ sourceSelect =', sourceSelect);
            if (!sourceSelect) {
                console.error('‚ùå editSourceContainer not found!');
                return;
            }
            
            const container = containers.find(c => c.id === item.container_id);
            console.log('üì¶ container =', container);
            if (!container) {
                console.error('‚ùå Container not found for container_id:', item.container_id);
                return;
            }
            
            // Vider le s√©lecteur
            sourceSelect.innerHTML = '<option value="">-- Choisir la source --</option>';
            
            // Trouver tous les articles du m√™me nom sur le m√™me site
            const sourcesDisponibles = inventory.filter(i => 
                i.name === item.name && 
                i.site === container.parent_site &&
                i.id !== item.id && // Pas soi-m√™me
                i.quantity > 0 // Seulement ceux qui ont du stock
            );
            
            console.log('üì¶ Sources disponibles:', sourcesDisponibles.length);
            
            sourcesDisponibles.forEach(source => {
                let label = '';
                if (source.container_id) {
                    const sourceContainer = containers.find(c => c.id === source.container_id);
                    label = sourceContainer ? sourceContainer.name : 'Conteneur inconnu';
                } else {
                    label = 'Stock libre (√©tag√®re)';
                }
                label += ` (${source.quantity} dispo)`;
                
                const option = document.createElement('option');
                option.value = source.id;
                option.textContent = label;
                sourceSelect.appendChild(option);
                console.log('  ‚úÖ Ajout√© source:', label, 'id=', source.id);
            });
            
            console.log('üì¶ Nombre total d\'options:', sourceSelect.options.length);
        }
        
        function updateEditQuantityLabel() {
            const action = document.getElementById('editAction').value;
            const label = document.getElementById('editQuantityLabel');
            
            if (action === 'add') {
                label.textContent = 'Quantit√© √† ajouter :';
            } else if (action === 'remove') {
                label.textContent = 'Quantit√© √† retirer :';
            } else {
                label.textContent = 'Nouvelle quantit√© :';
            }
        }
        
        function incrementEditQuantity() {
            const input = document.getElementById('editQuantity');
            let val = parseInt(input.value) || 0;
            input.value = val + 1;
        }
        
        function decrementEditQuantity() {
            const input = document.getElementById('editQuantity');
            let val = parseInt(input.value) || 0;
            if (val > 0) {
                input.value = val - 1;
            }
        }
        
        async function updateItem() {
            const item = inventory.find(i => i.id === currentEditItemId);
            if (!item) return;
            
            const action = document.getElementById('editAction').value;
            const quantity = parseInt(document.getElementById('editQuantity').value) || 0;
            const comment = document.getElementById('editComment').value.trim();
            const sourceSelect = document.getElementById('editSourceContainer');
            const sourceId = sourceSelect ? parseInt(sourceSelect.value) : null;
            
            const oldQty = item.quantity;
            let newQty = oldQty;
            
            // Si c'est un chef de bin√¥me qui ajoute dans son conteneur
            if (currentUserRole === 'chef-binome' && action === 'add' && item.container_id && sourceId) {
                // Transfert entre conteneurs/stock
                const sourceItem = inventory.find(i => i.id === sourceId);
                if (!sourceItem) {
                    alert('‚ö†Ô∏è Source introuvable');
                    return;
                }
                
                if (sourceItem.quantity < quantity) {
                    alert('‚ö†Ô∏è Stock insuffisant dans la source\n\nDemand√© : ' + quantity + '\nDisponible : ' + sourceItem.quantity);
                    return;
                }
                
                try {
                    // Utiliser la fonction s√©curis√©e pour le transfert
                    const { data, error } = await db.rpc('update_inventory_item', {
                        p_username: currentUser,
                        p_item_id: sourceId,
                        p_quantity: sourceItem.quantity - quantity
                    });
                    
                    if (error) throw error;
                    
                    sourceItem.quantity -= quantity;
                } catch (e) {
                    console.error('Erreur mise √† jour source:', e);
                    alert('‚ö†Ô∏è Erreur lors du transfert: ' + (e.message || 'Permission refus√©e'));
                    return;
                }
                
                // Ajouter √† la destination
                newQty = oldQty + quantity;
                
                const sourceLabel = sourceItem.container_id ? 
                    containers.find(c => c.id === sourceItem.container_id)?.name || 'Conteneur' : 
                    'Stock libre (√©tag√®re)';
                
                const desc = getCurrentUserData().firstname + ' a transf√©r√© ' + quantity + ' ' + item.name + 
                            ' depuis ' + sourceLabel + ' vers son sac (' + oldQty + ' ‚Üí ' + newQty + ')' +
                            (comment ? ' (' + comment + ')' : '');
                await addLog('Transfert', desc);
                
            } else if (currentUserRole === 'chef-binome' && action === 'add' && item.container_id && !sourceId) {
                // Chef de bin√¥me essaie d'ajouter sans choisir de source
                alert('‚ö†Ô∏è Vous devez choisir d\'o√π prendre le mat√©riel (Sac 2, Tour 1, √©tag√®re...)');
                return;
                
            } else if (action === 'remove') {
                // Consommation (diminue le stock global aussi)
                newQty = Math.max(0, oldQty - quantity);
                
                // Si c'est un conteneur, on consomme r√©ellement du stock global
                // Pas de remise dans l'√©tag√®re, c'est une vraie consommation
                const desc = getCurrentUserData().firstname + ' a consomm√© ' + quantity + ' ' + item.name + 
                            ' (' + oldQty + ' ‚Üí ' + newQty + ')' +
                            (comment ? ' (' + comment + ')' : '');
                await addLog('Consommation', desc);
                
            } else if (action === 'add' && !sourceId) {
                // Ajout simple (sans s√©lecteur de source)
                newQty = oldQty + quantity;
                
                const desc = getCurrentUserData().firstname + ' a ajout√© ' + quantity + ' ' + item.name + 
                            ' (' + oldQty + ' ‚Üí ' + newQty + ')' +
                            (comment ? ' (' + comment + ')' : '');
                await addLog('Ajout stock', desc);
                
            } else if (action === 'set') {
                // D√©finir une quantit√©
                newQty = quantity;
                
                const desc = getCurrentUserData().firstname + ' a d√©fini ' + item.name + 
                            ' : ' + oldQty + ' ‚Üí ' + newQty +
                            (comment ? ' (' + comment + ')' : '');
                await addLog('Modification stock', desc);
            }
            
            // Mettre √† jour l'item
            item.quantity = newQty;
            
            try {
                const { data, error } = await db.rpc('update_inventory_item', {
                    p_username: currentUser,
                    p_item_id: currentEditItemId,
                    p_quantity: newQty
                });
                
                if (error) throw error;
            } catch (e) {
                console.error('Erreur mise √† jour stock:', e);
                item.quantity = oldQty;
                alert('‚ö†Ô∏è Erreur lors de la mise √† jour: ' + (e.message || 'Permission refus√©e'));
                return;
            }
            
            // V√©rifier le seuil minimum
            const minThreshold = item.min_threshold || getMinThreshold(item) || 5;
            if (item.quantity <= minThreshold && item.quantity > 0) {
                const siteNames = {
                    'maraude': 'Maraude',
                    'stave': 'Saint Av√©',
                    'portlouis': 'Port Louis'
                };
                
                const alertMsg = '‚ö†Ô∏è ALERTE STOCK BAS\n\n' +
                                'Article : ' + item.name + '\n' +
                                'Site : ' + siteNames[item.site] + '\n' +
                                'Quantit√© actuelle : ' + item.quantity + '\n' +
                                'Seuil minimum : ' + minThreshold + '\n\n' +
                                '‚ö†Ô∏è R√©approvisionnement n√©cessaire !';
                
                if (currentUserRole === 'admin' || currentUserRole === 'chef-poste') {
                    alert(alertMsg);
                }
                
                await addLog('‚ö†Ô∏è Alerte stock', 'Stock bas pour ' + item.name + ' (' + item.quantity + '/' + minThreshold + ') sur ' + siteNames[item.site]);
            } else if (item.quantity === 0) {
                const siteNames = {
                    'maraude': 'Maraude',
                    'stave': 'Saint Av√©',
                    'portlouis': 'Port Louis'
                };
                
                const alertMsg = '‚ùå RUPTURE DE STOCK\n\n' +
                                'Article : ' + item.name + '\n' +
                                'Site : ' + siteNames[item.site] + '\n\n' +
                                '‚ùå Stock √©puis√© !';
                
                if (currentUserRole === 'admin' || currentUserRole === 'chef-poste') {
                    alert(alertMsg);
                }
                
                await addLog('‚ùå Rupture stock', 'Rupture de stock pour ' + item.name + ' sur ' + siteNames[item.site]);
            }
            
            closeModal('editItemModal');
            await autoSync(); // Synchronisation automatique
        }
        
        async function deleteItem(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;
            
            if (!confirm('Supprimer l\'article "' + item.name + '" ?')) return;
            
            // Supprimer via la fonction s√©curis√©e
            try {
                const { data, error } = await db.rpc('delete_inventory_item', {
                    p_username: currentUser,
                    p_item_id: itemId
                });
                
                if (error) throw error;
            } catch (e) {
                console.error('Erreur suppression article:', e);
                alert('‚ö†Ô∏è Erreur lors de la suppression: ' + (e.message || 'Permission refus√©e'));
                return;
            }
            
            // Supprimer localement
            inventory = inventory.filter(i => i.id !== itemId);
            
            await addLog('Suppression', getCurrentUserData().firstname + ' a supprim√© l\'article ' + item.name);
            await autoSync(); // Synchronisation automatique
        }
        
        // ============================================================================
        // GESTION DES UTILISATEURS (ADMIN)
        // ============================================================================
        
        async function showManageUsersModal() {
            if (currentUserRole !== 'admin') {
                alert('‚ö†Ô∏è Action r√©serv√©e aux administrateurs');
                return;
            }
            
            openModal('manageUsersModal');
            await loadUsersTable();
        }
        
        async function loadUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Chargement...</td></tr>';
            
            try {
                // Utiliser la fonction s√©curis√©e pour obtenir tous les utilisateurs
                const { data, error } = await db.rpc('get_all_users', {
                    p_username: currentUser
                });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Aucun utilisateur</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                data.forEach(user => {
                    const tr = document.createElement('tr');
                    
                    const roleLabels = {
                        'admin': 'üëë Admin',
                        'chef-poste': 'üéñÔ∏è Chef de poste',
                        'chef-equipe': '‚≠ê Chef d\'√©quipe',
                        'chef-binome': 'üë• Chef de bin√¥me'
                    };
                    
                    tr.innerHTML = `
                        <td>${user.firstname}</td>
                        <td>${roleLabels[user.role] || user.role}</td>
                        <td>${user.site || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="showEditUserModal(${user.id})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUserConfirm(${user.id}, '${user.username}')">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (e) {
                console.error('Erreur chargement utilisateurs:', e);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Erreur: ' + (e.message || 'Chargement impossible') + '</td></tr>';
            }
        }
        
        function showAddUserModal() {
            currentEditUserId = null;
            document.getElementById('userModalTitle').textContent = '‚ûï Ajouter utilisateur';
            document.getElementById('userFirstname').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userGrade').value = 'chef-binome';
            document.getElementById('userSite').value = '';
            
            closeModal('manageUsersModal');
            openModal('addUserModal');
        }
        
        async function showEditUserModal(userId) {
            currentEditUserId = userId;
            
            try {
                // R√©cup√©rer les infos de l'utilisateur
                const { data, error } = await db.rpc('get_all_users', {
                    p_username: currentUser
                });
                
                if (error) throw error;
                
                const user = data.find(u => u.id === userId);
                if (!user) {
                    alert('‚ö†Ô∏è Utilisateur non trouv√©');
                    return;
                }
                
                document.getElementById('userModalTitle').textContent = '‚úèÔ∏è Modifier utilisateur';
                document.getElementById('userFirstname').value = user.firstname;
                document.getElementById('userPassword').value = ''; // Vide = pas de changement
                document.getElementById('userPassword').placeholder = 'Laisser vide pour ne pas changer';
                document.getElementById('userGrade').value = user.role;
                document.getElementById('userSite').value = user.site || '';
                
                closeModal('manageUsersModal');
                openModal('addUserModal');
                
            } catch (e) {
                console.error('Erreur chargement utilisateur:', e);
                alert('‚ö†Ô∏è Erreur lors du chargement');
            }
        }
        
        async function saveUser() {
            const firstname = document.getElementById('userFirstname').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userGrade').value;
            const site = document.getElementById('userSite').value || null;
            
            if (!firstname) {
                alert('‚ö†Ô∏è Veuillez entrer un pr√©nom');
                return;
            }
            
            // G√©n√©rer un username √† partir du pr√©nom (en minuscules, sans espaces)
            const username = firstname.toLowerCase().replace(/\s+/g, '');
            
            try {
                if (currentEditUserId) {
                    // Modification
                    const { data, error } = await db.rpc('update_user', {
                        p_admin_username: currentUser,
                        p_user_id: currentEditUserId,
                        p_username: username,
                        p_firstname: firstname,
                        p_role: role,
                        p_site: site,
                        p_assigned_container_id: null,
                        p_new_password: password || null
                    });
                    
                    if (error) throw error;
                    
                    await addLog('Modification utilisateur', `${getCurrentUserData().firstname} a modifi√© l'utilisateur ${firstname}`);
                    alert('‚úÖ Utilisateur modifi√© avec succ√®s');
                    
                } else {
                    // Cr√©ation
                    if (!password || password.length < 4) {
                        alert('‚ö†Ô∏è Le mot de passe doit faire au moins 4 caract√®res');
                        return;
                    }
                    
                    const { data, error } = await db.rpc('create_user', {
                        p_admin_username: currentUser,
                        p_new_username: username,
                        p_password: password,
                        p_firstname: firstname,
                        p_role: role,
                        p_site: site,
                        p_assigned_container_id: null
                    });
                    
                    if (error) throw error;
                    
                    await addLog('Cr√©ation utilisateur', `${getCurrentUserData().firstname} a cr√©√© l'utilisateur ${firstname}`);
                    alert('‚úÖ Utilisateur cr√©√© avec succ√®s\n\nIdentifiant: ' + username + '\nMot de passe: ' + password);
                }
                
                closeModal('addUserModal');
                await loadUsersTable();
                openModal('manageUsersModal');
                
            } catch (e) {
                console.error('Erreur sauvegarde utilisateur:', e);
                alert('‚ö†Ô∏è Erreur: ' + (e.message || 'Impossible de sauvegarder'));
            }
        }
        
        async function deleteUserConfirm(userId, username) {
            if (!confirm(`Supprimer l'utilisateur "${username}" ?\n\nCette action est irr√©versible.`)) {
                return;
            }
            
            try {
                const { data, error } = await db.rpc('delete_user', {
                    p_admin_username: currentUser,
                    p_user_id: userId
                });
                
                if (error) throw error;
                
                await addLog('Suppression utilisateur', `${getCurrentUserData().firstname} a supprim√© l'utilisateur ${username}`);
                alert('‚úÖ Utilisateur supprim√©');
                
                await loadUsersTable();
                
            } catch (e) {
                console.error('Erreur suppression utilisateur:', e);
                alert('‚ö†Ô∏è Erreur: ' + (e.message || 'Impossible de supprimer'));
            }
        }
        
        // ============================================================================
        // GESTION MAT√âRIEL CHEF DE BIN√îME
        // ============================================================================
        
        function showTakeMaterialModal() {
            if (currentUserRole !== 'chef-binome') {
                alert('‚ö†Ô∏è Action r√©serv√©e aux chefs de bin√¥me');
                return;
            }
            
            // Remplir la liste des conteneurs disponibles (sacs et tours du m√™me site)
            const select = document.getElementById('takeContainerSelect');
            select.innerHTML = '<option value="">-- S√©lectionnez votre sac --</option>';
            
            // Trouver le site du chef de bin√¥me
            const binomeSite = currentRole ? currentRole.site : null;
            if (!binomeSite) {
                alert('‚ö†Ô∏è Site non d√©fini pour votre compte');
                return;
            }
            
            // Filtrer les conteneurs du m√™me site
            const availableContainers = containers.filter(c => c.parent_site === binomeSite && c.active);
            
            availableContainers.forEach(container => {
                const option = document.createElement('option');
                option.value = container.id;
                option.textContent = container.name;
                select.appendChild(option);
            });
            
            // Pr√©-s√©lectionner le conteneur actuel si d√©fini
            if (selectedContainerId) {
                select.value = selectedContainerId;
            }
            
            // Masquer l'inventaire au d√©part
            document.getElementById('takeContainerInventory').style.display = 'none';
            
            openModal('takeMaterialModal');
        }
        
        function updateTakeContainerInventory() {
            const containerId = parseInt(document.getElementById('takeContainerSelect').value);
            
            if (!containerId) {
                return;
            }
            
            // Sauvegarder le conteneur s√©lectionn√© dans une variable globale
            selectedContainerId = containerId;
            
            // Fermer le modal
            closeModal('takeMaterialModal');
            
            // Recharger l'affichage avec le conteneur s√©lectionn√©
            displayInventory();
            updateStats();
        }
        
        // ============================================================================
        // PRENDRE UN ARTICLE (CHEF DE BIN√îME)
        // ============================================================================
        
        function showTakeArticleModal() {
            if (currentUserRole !== 'chef-binome') {
                alert('‚ö†Ô∏è Action r√©serv√©e aux chefs de bin√¥me');
                return;
            }
            
            if (!selectedContainerId) {
                alert('‚ö†Ô∏è Veuillez d\'abord choisir votre sac avec "üì¶ Choisir mon sac"');
                return;
            }
            
            const binomeSite = currentRole ? currentRole.site : null;
            if (!binomeSite) {
                alert('‚ö†Ô∏è Site non d√©fini');
                return;
            }
            
            // Lister tous les articles uniques du site (sans conteneur = stock libre)
            const siteArticles = {};
            inventory.filter(item => item.site === binomeSite && !item.container_id).forEach(item => {
                if (!siteArticles[item.name]) {
                    siteArticles[item.name] = {
                        name: item.name,
                        type: item.type,
                        totalStock: 0,
                        items: []
                    };
                }
                siteArticles[item.name].totalStock += item.quantity;
                siteArticles[item.name].items.push(item);
            });
            
            // Remplir le s√©lecteur d'articles
            const select = document.getElementById('takeArticleSelect');
            select.innerHTML = '<option value="">-- Choisir un article --</option>';
            
            Object.values(siteArticles).forEach(article => {
                if (article.totalStock > 0) {
                    const option = document.createElement('option');
                    option.value = article.name;
                    option.textContent = `${article.name} (${article.totalStock} dispo)`;
                    select.appendChild(option);
                }
            });
            
            document.getElementById('takeArticleInfo').style.display = 'none';
            document.getElementById('takeArticleQuantity').value = 1;
            
            openModal('takeArticleModal');
        }
        
        function updateTakeArticleInfo() {
            const articleName = document.getElementById('takeArticleSelect').value;
            
            if (!articleName) {
                document.getElementById('takeArticleInfo').style.display = 'none';
                document.getElementById('takeArticleSource').innerHTML = '<option value="">-- Choisir la source --</option>';
                return;
            }
            
            const binomeSite = currentRole ? currentRole.site : null;
            
            // Calculer le stock total
            const allArticles = inventory.filter(i => i.name === articleName && i.site === binomeSite);
            const totalStock = allArticles.reduce((sum, i) => sum + i.quantity, 0);
            
            // Trouver le type
            const firstArticle = allArticles[0];
            
            document.getElementById('takeArticleTotalStock').textContent = totalStock;
            document.getElementById('takeArticleType').textContent = firstArticle.type === 'retournable' ? 'Retournable' : 'Consommable';
            document.getElementById('takeArticleInfo').style.display = 'block';
            
            // Remplir les sources disponibles
            const sourceSelect = document.getElementById('takeArticleSource');
            sourceSelect.innerHTML = '<option value="">-- Choisir la source --</option>';
            
            allArticles.filter(item => item.quantity > 0).forEach(item => {
                let label = '';
                if (item.container_id) {
                    const container = containers.find(c => c.id === item.container_id);
                    label = container ? container.name : 'Conteneur inconnu';
                } else {
                    label = 'Stock libre (√©tag√®re)';
                }
                label += ` (${item.quantity} dispo)`;
                
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = label;
                sourceSelect.appendChild(option);
            });
        }
        
        function decrementTakeArticleQty() {
            const input = document.getElementById('takeArticleQuantity');
            let val = parseInt(input.value) || 1;
            if (val > 1) input.value = val - 1;
        }
        
        function incrementTakeArticleQty() {
            const input = document.getElementById('takeArticleQuantity');
            let val = parseInt(input.value) || 1;
            input.value = val + 1;
        }
        
        async function confirmTakeArticle() {
            const articleName = document.getElementById('takeArticleSelect').value;
            const quantity = parseInt(document.getElementById('takeArticleQuantity').value) || 0;
            const sourceId = parseInt(document.getElementById('takeArticleSource').value);
            
            if (!articleName) {
                alert('‚ö†Ô∏è Veuillez choisir un article');
                return;
            }
            
            if (!sourceId) {
                alert('‚ö†Ô∏è Veuillez choisir la source');
                return;
            }
            
            if (quantity <= 0) {
                alert('‚ö†Ô∏è Quantit√© invalide');
                return;
            }
            
            const sourceItem = inventory.find(i => i.id === sourceId);
            if (!sourceItem) {
                alert('‚ö†Ô∏è Source introuvable');
                return;
            }
            
            if (sourceItem.quantity < quantity) {
                alert(`‚ö†Ô∏è Stock insuffisant\n\nDemand√© : ${quantity}\nDisponible : ${sourceItem.quantity}`);
                return;
            }
            
            try {
                // Utiliser la fonction s√©curis√©e de transfert
                const { data, error } = await db.rpc('transfer_inventory', {
                    p_username: currentUser,
                    p_source_id: sourceId,
                    p_target_container_id: selectedContainerId,
                    p_quantity: quantity,
                    p_article_name: articleName
                });
                
                if (error) throw error;
                
                // Recharger l'inventaire pour avoir les donn√©es √† jour
                await loadInventory();
                
                const sourceLabel = sourceItem.container_id ? 
                    containers.find(c => c.id === sourceItem.container_id)?.name || 'Conteneur' : 
                    'Stock libre';
                
                const containerName = containers.find(c => c.id === selectedContainerId)?.name || 'Sac';
                
                await addLog('Transfert', `${getCurrentUserData().firstname} a pris ${quantity} ${articleName} depuis ${sourceLabel} vers ${containerName}`);
                
                closeModal('takeArticleModal');
                await autoSync(); // Synchronisation automatique
                
                alert(`‚úÖ ${quantity} ${articleName} ajout√©(s) √† votre ${containerName}`);
                
            } catch (e) {
                console.error('Erreur:', e);
                alert('‚ö†Ô∏è Erreur lors du transfert');
            }
        }
        
        
        // ============================================================================
        // EXPORTS
        // ============================================================================
        // ============================================================================
        // EXPORTS
        // ============================================================================
        
        function exportInventory() {
            let txt = 'INVENTAIRE PROTECTION CIVILE 56\n';
            txt += 'Export le : ' + new Date().toLocaleString('fr-FR') + '\n';
            txt += 'Par : ' + getCurrentUserData().firstname + '\n';
            txt += '='.repeat(80) + '\n\n';
            
            const filtered = getFilteredInventory();
            
            filtered.forEach(item => {
                const siteNames = {
                    'maraude': 'Maraude',
                    'stave': 'Saint Av√©',
                    'portlouis': 'Port Louis'
                };
                
                txt += 'Article : ' + item.name + '\n';
                txt += 'Site : ' + siteNames[item.site] + '\n';
                txt += 'Quantit√© : ' + item.quantity + '\n';
                txt += 'Seuil minimum : ' + getMinThreshold(item) + '\n';
                txt += 'Type : ' + (item.type === 'retournable' ? 'Retournable' : 'Consommable') + '\n';
                txt += 'Cat√©gorie : ' + item.category + '\n';
                txt += '-'.repeat(80) + '\n';
            });
            
            const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inventaire_pc56_' + new Date().toISOString().split('T')[0] + '.txt';
            a.click();
            
            addLog('Export', getCurrentUserData().firstname + ' a export√© l\'inventaire');
        }
        
        function exportMyInventory() {
            if (currentUserRole !== 'chef-binome') return;
            
            const myItems = userInventories[currentUser] || [];
            
            let txt = 'MON MAT√âRIEL - PROTECTION CIVILE 56\n';
            txt += 'Chef de bin√¥me : ' + getCurrentUserData().firstname + '\n';
            txt += 'Export le : ' + new Date().toLocaleString('fr-FR') + '\n';
            txt += '='.repeat(80) + '\n\n';
            
            if (myItems.length === 0) {
                txt += 'Aucun mat√©riel pris\n';
            } else {
                myItems.forEach(item => {
                    txt += 'Article : ' + item.itemName + '\n';
                    txt += 'Quantit√© : ' + item.quantity + '\n';
                    txt += 'Type : ' + (item.type === 'retournable' ? 'Retournable' : 'Consommable') + '\n';
                    txt += '-'.repeat(80) + '\n';
                });
            }
            
            const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mon_materiel_' + currentUser + '_' + new Date().toISOString().split('T')[0] + '.txt';
            a.click();
            
            addLog('Export', getCurrentUserData().firstname + ' a export√© son inventaire personnel');
        }
        
        function exportLogs() {
            let txt = 'LOGS - PROTECTION CIVILE 56\n';
            txt += 'Export le : ' + new Date().toLocaleString('fr-FR') + '\n';
            txt += 'Par : ' + getCurrentUserData().firstname + '\n';
            txt += '='.repeat(80) + '\n\n';
            
            txt += 'Date       | Heure    | Action            | Description\n';
            txt += '-'.repeat(80) + '\n';
            
            logs.forEach(log => {
                const date = new Date(log.timestamp);
                const dateStr = date.toLocaleDateString('fr-FR');
                const timeStr = date.toLocaleTimeString('fr-FR');
                txt += dateStr.padEnd(11) + '| ' + timeStr.padEnd(9) + '| ' + log.action.padEnd(18) + '| ' + log.description + '\n';
            });
            
            const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'logs_pc56_' + new Date().toISOString().split('T')[0] + '.txt';
            a.click();
            
            addLog('Export', getCurrentUserData().firstname + ' a export√© les logs');
        }
        
        // ============================================================================
        // MODALS
        // ============================================================================
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // ============================================================================
        // D√âMARRAGE
        // ============================================================================
        
        window.onload = init;
        
    </script>
</body>
</html>
