<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Inventaire - Protection Civile 56</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .logo {
            height: 60px;
            width: auto;
            background: white;
            padding: 5px;
            border-radius: 8px;
        }

        .header-title {
            flex: 1;
            min-width: 200px;
        }

        .header-title h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header-title p {
            font-size: 14px;
            opacity: 0.9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
        }

        .login-container {
            padding: 40px;
            max-width: 400px;
            margin: 50px auto;
        }

        .login-container h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f97316;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            margin-top: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            width: auto;
            font-size: 14px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .content {
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #f3f4f6;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .controls select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: #f97316;
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .alert-row {
            background: #fef3c7 !important;
        }

        .danger-row {
            background: #fecaca !important;
        }

        .quantity-display {
            font-size: 32px;
            font-weight: bold;
            color: #f97316;
            cursor: pointer;
            user-select: none;
        }

        .item-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .btn-remove {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-remove:hover {
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 24px;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .alert-danger {
            background: #fecaca;
            border-left: 4px solid #dc2626;
            color: #991b1b;
        }

        .role-selector {
            padding: 30px;
            max-width: 500px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
        }

        .role-card {
            padding: 20px;
            margin: 10px 0;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .role-card:hover {
            border-color: #f97316;
            background: #fff7ed;
        }

        .role-card h3 {
            color: #f97316;
            margin-bottom: 5px;
        }

        .role-card p {
            color: #666;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .header-title h1 {
                font-size: 18px;
            }
            
            .header-title p {
                font-size: 12px;
            }

            .logo {
                height: 50px;
            }

            th:not(:first-child):not(:nth-child(2)):not(:last-child),
            td:not(:first-child):not(:nth-child(2)):not(:last-child) {
                display: none;
            }

            .quantity-display {
                font-size: 28px;
            }

            .item-name {
                font-size: 16px;
            }

            .content {
                padding: 10px;
            }
        }

        .hidden {
            display: none;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-admin {
            background: #dc2626;
            color: white;
        }

        .badge-chef-poste {
            background: #f97316;
            color: white;
        }

        .badge-chef-equipe {
            background: #3b82f6;
            color: white;
        }

        .badge-chef-binome {
            background: #10b981;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- √âcran de connexion -->
        <div id="loginScreen" class="login-container">
            <img src="Gemini_Generated_Image_ij9pboij9pboij9p-removebg-preview.png" alt="Logo Protection Civile 56" style="display: block; margin: 0 auto 20px; height: 80px;">
            <h2>Connexion Inventaire PC56</h2>
            <div class="form-group">
                <label>Identifiant</label>
                <input type="text" id="loginUsername" placeholder="Votre identifiant">
            </div>
            <div class="form-group">
                <label>Mot de passe</label>
                <input type="password" id="loginPassword" placeholder="Votre mot de passe">
            </div>
            <button class="btn" onclick="login()">Se connecter</button>
            <div id="loginError" class="alert alert-danger hidden" style="margin-top: 20px;"></div>
        </div>

        <!-- S√©lecteur de r√¥le (multi-r√¥les) -->
        <div id="roleSelector" class="role-selector hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">S√©lectionnez votre r√¥le</h2>
            <div id="rolesList"></div>
        </div>

        <!-- Application principale -->
        <div id="mainApp" class="hidden">
            <div class="header">
                <img src="Gemini_Generated_Image_ij9pboij9pboij9p-removebg-preview.png" alt="Logo PC56" class="logo">
                <div class="header-title">
                    <h1>Protection Civile 56</h1>
                    <p>Gestion d'inventaire multi-sites</p>
                </div>
                <div class="user-info">
                    <div>
                        <strong id="userDisplay"></strong><br>
                        <small id="roleDisplay"></small>
                    </div>
                    <button class="btn btn-small btn-secondary" onclick="logout()">D√©connexion</button>
                </div>
            </div>

            <div class="content">
                <!-- Onglets -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('inventory')">Inventaire</button>
                    <button class="tab" id="usersTab" onclick="switchTab('users')">Utilisateurs</button>
                    <button class="tab" id="containersTab" onclick="switchTab('containers')">Conteneurs</button>
                    <button class="tab" onclick="switchTab('logs')">Historique</button>
                </div>

                <!-- Section Inventaire -->
                <div id="inventorySection">
                    <div class="controls">
                        <select id="siteFilter" onchange="loadInventory()">
                            <option value="">-- Site --</option>
                            <option value="maraude">Maraude</option>
                            <option value="stave">Saint Av√©</option>
                            <option value="portlouis">Port Louis</option>
                        </select>
                        <select id="containerFilter" onchange="loadInventory()">
                            <option value="">-- Tous les stocks --</option>
                        </select>
                        <button class="btn btn-small" onclick="showAddItemModal()">‚ûï Ajouter article</button>
                    </div>

                    <div id="alerts"></div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Article</th>
                                    <th>Quantit√©</th>
                                    <th>Seuil min</th>
                                    <th>Type</th>
                                    <th>Cat√©gorie</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Section Utilisateurs -->
                <div id="usersSection" class="hidden">
                    <button class="btn btn-small" onclick="showAddUserModal()" style="margin-bottom: 20px;">‚ûï Ajouter utilisateur</button>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Nom</th>
                                    <th>R√¥les</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Section Conteneurs -->
                <div id="containersSection" class="hidden">
                    <button class="btn btn-small" onclick="showAddContainerModal()" style="margin-bottom: 20px;">‚ûï Ajouter conteneur</button>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Type</th>
                                    <th>Site parent</th>
                                    <th>Actif</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="containersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Section Historique -->
                <div id="logsSection" class="hidden">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Utilisateur</th>
                                    <th>Action</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="logsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('editModal')">&times;</span>
            <div class="modal-header">
                <h3>Modifier la quantit√©</h3>
            </div>
            <div class="form-group">
                <label>Nouvelle quantit√©</label>
                <input type="number" id="editQuantity" min="0">
            </div>
            <button class="btn" onclick="updateQuantity()">Valider</button>
        </div>
    </div>

    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('addItemModal')">&times;</span>
            <div class="modal-header">
                <h3>Ajouter un article</h3>
            </div>
            <div class="form-group">
                <label>Nom de l'article</label>
                <input type="text" id="newItemName">
            </div>
            <div class="form-group">
                <label>Site</label>
                <select id="newItemSite">
                    <option value="maraude">Maraude</option>
                    <option value="stave">Saint Av√©</option>
                    <option value="portlouis">Port Louis</option>
                </select>
            </div>
            <div class="form-group">
                <label>Conteneur (optionnel)</label>
                <select id="newItemContainer">
                    <option value="">Aucun (stock g√©n√©ral)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Quantit√© initiale</label>
                <input type="number" id="newItemQuantity" min="0" value="0">
            </div>
            <div class="form-group">
                <label>Seuil minimum</label>
                <input type="number" id="newItemThreshold" min="0" value="5">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="newItemType">
                    <option value="consommable">Consommable</option>
                    <option value="materiel">Mat√©riel</option>
                </select>
            </div>
            <div class="form-group">
                <label>Cat√©gorie</label>
                <select id="newItemCategory">
                    <option value="medical">M√©dical</option>
                    <option value="alimentaire">Alimentaire</option>
                    <option value="hygiene">Hygi√®ne</option>
                    <option value="autre">Autre</option>
                </select>
            </div>
            <button class="btn" onclick="addItem()">Ajouter</button>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('addUserModal')">&times;</span>
            <div class="modal-header">
                <h3>Ajouter un utilisateur</h3>
            </div>
            <div class="form-group">
                <label>Identifiant</label>
                <input type="text" id="newUsername">
            </div>
            <div class="form-group">
                <label>Mot de passe</label>
                <input type="password" id="newPassword">
            </div>
            <div class="form-group">
                <label>Pr√©nom</label>
                <input type="text" id="newFirstname">
            </div>
            <button class="btn" onclick="addUser()">Cr√©er l'utilisateur</button>
        </div>
    </div>

    <div id="manageRolesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('manageRolesModal')">&times;</span>
            <div class="modal-header">
                <h3>G√©rer les r√¥les de <span id="rolesUsername"></span></h3>
            </div>
            <div id="rolesManagement"></div>
            <button class="btn" onclick="showAddRoleForm()">‚ûï Ajouter un r√¥le</button>
            <div id="addRoleForm" class="hidden" style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                <div class="form-group">
                    <label>Type de r√¥le</label>
                    <select id="newRoleType">
                        <option value="admin">Admin</option>
                        <option value="chef-poste">Chef de poste</option>
                        <option value="chef-equipe">Chef d'√©quipe</option>
                        <option value="chef-binome">Chef de bin√¥me</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Site (chef de poste uniquement)</label>
                    <select id="newRoleSite">
                        <option value="">Aucun</option>
                        <option value="maraude">Maraude</option>
                        <option value="stave">Saint Av√©</option>
                        <option value="portlouis">Port Louis</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Conteneur (chef de bin√¥me uniquement)</label>
                    <select id="newRoleContainer">
                        <option value="">Aucun</option>
                    </select>
                </div>
                <button class="btn btn-small" onclick="addRole()">Ajouter ce r√¥le</button>
            </div>
        </div>
    </div>

    <div id="addContainerModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('addContainerModal')">&times;</span>
            <div class="modal-header">
                <h3>Ajouter un conteneur</h3>
            </div>
            <div class="form-group">
                <label>Nom du conteneur</label>
                <input type="text" id="newContainerName" placeholder="ex: Sac de secours 3">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="newContainerType">
                    <option value="sac">Sac de secours</option>
                    <option value="tour">Tour de soins</option>
                </select>
            </div>
            <div class="form-group">
                <label>Site parent</label>
                <select id="newContainerSite">
                    <option value="maraude">Maraude</option>
                    <option value="stave">Saint Av√©</option>
                    <option value="portlouis">Port Louis</option>
                </select>
            </div>
            <button class="btn" onclick="addContainer()">Cr√©er le conteneur</button>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://hnmftuipbpcfavtotfaf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhubWZ0dWlwYnBjZmF2dG90ZmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNzgxMDUsImV4cCI6MjA4NjY1NDEwNX0.JRHkP5eTvBcnCNsLCvjo9EBh3lDQoeTLj6-9Vimk39M';
        let supabase;
        
        // Initialiser Supabase une fois le DOM charg√©
        document.addEventListener('DOMContentLoaded', function() {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        });

        // Variables globales
        let currentUser = null;
        let currentRole = null;
        let userRoles = [];
        let editingItemId = null;

        // Connexion
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showError('loginError', 'Veuillez remplir tous les champs');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();

                if (error || !data) {
                    showError('loginError', 'Identifiants incorrects');
                    return;
                }

                currentUser = data;

                // Charger tous les r√¥les de l'utilisateur
                const { data: roles, error: rolesError } = await supabase
                    .from('user_roles')
                    .select('*, containers(name)')
                    .eq('username', username);

                if (!rolesError && roles && roles.length > 0) {
                    userRoles = roles;
                    
                    if (roles.length === 1) {
                        // Un seul r√¥le : connexion directe
                        currentRole = roles[0];
                        showMainApp();
                    } else {
                        // Plusieurs r√¥les : afficher le s√©lecteur
                        showRoleSelector();
                    }
                } else {
                    showError('loginError', 'Aucun r√¥le assign√© √† cet utilisateur');
                }
            } catch (err) {
                showError('loginError', 'Erreur de connexion : ' + err.message);
            }
        }

        function showRoleSelector() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('roleSelector').classList.remove('hidden');

            const rolesList = document.getElementById('rolesList');
            rolesList.innerHTML = '';

            userRoles.forEach(role => {
                const roleCard = document.createElement('div');
                roleCard.className = 'role-card';
                roleCard.onclick = () => selectRole(role);

                let roleLabel = '';
                let roleDesc = '';

                switch(role.role_type) {
                    case 'admin':
                        roleLabel = 'Administrateur';
                        roleDesc = 'Gestion compl√®te de tous les sites et utilisateurs';
                        break;
                    case 'chef-poste':
                        roleLabel = `Chef de poste - ${role.site.toUpperCase()}`;
                        roleDesc = `Gestion du site ${role.site}`;
                        break;
                    case 'chef-equipe':
                        roleLabel = `Chef d'√©quipe - ${role.site.toUpperCase()}`;
                        roleDesc = `Gestion d'√©quipe sur ${role.site}`;
                        break;
                    case 'chef-binome':
                        const containerName = role.containers ? role.containers.name : 'Conteneur inconnu';
                        roleLabel = `Chef de bin√¥me - ${containerName}`;
                        roleDesc = `Gestion du conteneur ${containerName}`;
                        break;
                }

                roleCard.innerHTML = `
                    <h3>${roleLabel}</h3>
                    <p>${roleDesc}</p>
                `;

                rolesList.appendChild(roleCard);
            });
        }

        function selectRole(role) {
            currentRole = role;
            showMainApp();
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('roleSelector').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            document.getElementById('userDisplay').textContent = currentUser.firstname || currentUser.username;
            
            let roleText = '';
            switch(currentRole.role_type) {
                case 'admin':
                    roleText = 'Administrateur';
                    break;
                case 'chef-poste':
                    roleText = `Chef de poste - ${currentRole.site}`;
                    break;
                case 'chef-equipe':
                    roleText = `Chef d'√©quipe - ${currentRole.site}`;
                    break;
                case 'chef-binome':
                    roleText = `Chef de bin√¥me`;
                    break;
            }
            document.getElementById('roleDisplay').textContent = roleText;

            // Afficher/masquer les onglets selon les permissions
            if (currentRole.role_type === 'admin') {
                document.getElementById('usersTab').classList.remove('hidden');
                document.getElementById('containersTab').classList.remove('hidden');
            } else {
                document.getElementById('usersTab').classList.add('hidden');
                document.getElementById('containersTab').classList.add('hidden');
            }

            loadContainers();
            loadInventory();
        }

        function logout() {
            currentUser = null;
            currentRole = null;
            userRoles = [];
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showError(elementId, message) {
            const elem = document.getElementById(elementId);
            elem.textContent = message;
            elem.classList.remove('hidden');
            setTimeout(() => elem.classList.add('hidden'), 5000);
        }

        // Navigation
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('inventorySection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('containersSection').classList.add('hidden');
            document.getElementById('logsSection').classList.add('hidden');

            switch(tab) {
                case 'inventory':
                    document.getElementById('inventorySection').classList.remove('hidden');
                    loadInventory();
                    break;
                case 'users':
                    document.getElementById('usersSection').classList.remove('hidden');
                    loadUsers();
                    break;
                case 'containers':
                    document.getElementById('containersSection').classList.remove('hidden');
                    loadContainersTable();
                    break;
                case 'logs':
                    document.getElementById('logsSection').classList.remove('hidden');
                    loadLogs();
                    break;
            }
        }

        // Charger les conteneurs dans les filtres
        async function loadContainers() {
            try {
                const { data, error } = await supabase
                    .from('containers')
                    .select('*')
                    .eq('active', true)
                    .order('name');

                if (error) throw error;

                const containerFilter = document.getElementById('containerFilter');
                const newItemContainer = document.getElementById('newItemContainer');
                const newRoleContainer = document.getElementById('newRoleContainer');

                containerFilter.innerHTML = '<option value="">-- Tous les stocks --</option>';
                newItemContainer.innerHTML = '<option value="">Aucun (stock g√©n√©ral)</option>';
                newRoleContainer.innerHTML = '<option value="">Aucun</option>';

                data.forEach(container => {
                    const option1 = new Option(`${container.name} (${container.parent_site})`, container.id);
                    const option2 = new Option(`${container.name} (${container.parent_site})`, container.id);
                    const option3 = new Option(`${container.name} (${container.parent_site})`, container.id);
                    
                    containerFilter.appendChild(option1);
                    newItemContainer.appendChild(option2);
                    newRoleContainer.appendChild(option3);
                });
            } catch (err) {
                console.error('Erreur chargement conteneurs:', err);
            }
        }

        // Charger l'inventaire
        async function loadInventory() {
            try {
                const site = document.getElementById('siteFilter').value;
                const containerId = document.getElementById('containerFilter').value;

                let query = supabase
                    .from('inventory')
                    .select('*, containers(name, parent_site)')
                    .order('name');

                // Filtrage selon les permissions
                if (currentRole.role_type === 'chef-poste') {
                    query = query.eq('site', currentRole.site);
                } else if (currentRole.role_type === 'chef-binome') {
                    query = query.eq('container_id', currentRole.container_id);
                } else if (site) {
                    query = query.eq('site', site);
                }

                if (containerId) {
                    query = query.eq('container_id', parseInt(containerId));
                }

                const { data, error } = await supabase
                    .from('inventory')
                    .select('*, containers(name, parent_site)')
                    .order('name');

                if (error) throw error;

                // Filtrer les donn√©es apr√®s r√©cup√©ration selon les permissions
                let filteredData = data;
                
                if (currentRole.role_type === 'chef-poste') {
                    filteredData = data.filter(item => item.site === currentRole.site);
                } else if (currentRole.role_type === 'chef-binome') {
                    filteredData = data.filter(item => item.container_id === currentRole.container_id);
                } else if (site) {
                    filteredData = data.filter(item => item.site === site);
                }

                if (containerId) {
                    filteredData = filteredData.filter(item => item.container_id === parseInt(containerId));
                }

                displayInventory(filteredData);
                checkAlerts(filteredData);
            } catch (err) {
                console.error('Erreur chargement inventaire:', err);
            }
        }

        function displayInventory(data) {
            const tbody = document.getElementById('inventoryTable');
            tbody.innerHTML = '';

            data.forEach(item => {
                const row = document.createElement('tr');
                
                // Coloration selon le stock
                if (item.quantity === 0) {
                    row.classList.add('danger-row');
                } else if (item.quantity <= item.min_threshold) {
                    row.classList.add('alert-row');
                }

                const containerInfo = item.containers ? ` (${item.containers.name})` : '';

                row.innerHTML = `
                    <td><span class="item-name">${item.name}${containerInfo}</span></td>
                    <td><span class="quantity-display" onclick="showEditModal(${item.id}, ${item.quantity})">${item.quantity}</span></td>
                    <td>${item.min_threshold}</td>
                    <td>${item.type}</td>
                    <td>${item.category}</td>
                    <td>
                        ${item.type === 'consommable' ? `<button class="btn-remove" onclick="quickRemove(${item.id}, '${item.name}', ${item.quantity}, ${item.container_id || 'null'}, '${item.site}')">‚ûñ</button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="deleteItem(${item.id}, '${item.name}')">üóëÔ∏è</button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function checkAlerts(data) {
            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = '';

            const lowStock = data.filter(item => item.quantity > 0 && item.quantity <= item.min_threshold);
            const outOfStock = data.filter(item => item.quantity === 0);

            if (outOfStock.length > 0) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger';
                alert.innerHTML = `<strong>‚ö†Ô∏è Rupture de stock !</strong><br>${outOfStock.map(i => i.name).join(', ')}`;
                alertsDiv.appendChild(alert);
            }

            if (lowStock.length > 0) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-warning';
                alert.innerHTML = `<strong>‚ö†Ô∏è Stock faible !</strong><br>${lowStock.map(i => i.name).join(', ')}`;
                alertsDiv.appendChild(alert);
            }
        }

        // Retrait rapide (-1)
        async function quickRemove(itemId, itemName, currentQty, containerId, site) {
            if (currentQty <= 0) {
                alert('Stock d√©j√† √† 0');
                return;
            }

            try {
                const newQty = currentQty - 1;

                // Mettre √† jour le conteneur
                await supabase
                    .from('inventory')
                    .update({ quantity: newQty })
                    .eq('id', itemId);

                // Si c'est un conteneur, retirer aussi du stock global
                if (containerId) {
                    const { data: globalItem } = await supabase
                        .from('inventory')
                        .select('*')
                        .eq('name', itemName)
                        .eq('site', site)
                        .is('container_id', null)
                        .single();

                    if (globalItem && globalItem.quantity > 0) {
                        await supabase
                            .from('inventory')
                            .update({ quantity: globalItem.quantity - 1 })
                            .eq('id', globalItem.id);
                    }
                }

                // Log
                await supabase.from('logs').insert({
                    username: currentUser.username,
                    action: 'retrait',
                    description: `Retrait rapide -1 : ${itemName} (quantit√©: ${newQty})`
                });

                loadInventory();
            } catch (err) {
                alert('Erreur lors du retrait : ' + err.message);
            }
        }

        // √âdition de quantit√©
        function showEditModal(itemId, currentQty) {
            editingItemId = itemId;
            document.getElementById('editQuantity').value = currentQty;
            document.getElementById('editModal').classList.add('active');
        }

        async function updateQuantity() {
            const newQty = parseInt(document.getElementById('editQuantity').value);

            if (newQty < 0) {
                alert('La quantit√© ne peut pas √™tre n√©gative');
                return;
            }

            try {
                const { data: item } = await supabase
                    .from('inventory')
                    .select('*, containers(parent_site)')
                    .eq('id', editingItemId)
                    .single();

                const oldQty = item.quantity;

                await supabase
                    .from('inventory')
                    .update({ quantity: newQty })
                    .eq('id', editingItemId);

                // Si c'est un conteneur, ajuster le stock global
                if (item.container_id) {
                    const diff = newQty - oldQty;
                    const parentSite = item.containers.parent_site;

                    const { data: globalItem } = await supabase
                        .from('inventory')
                        .select('*')
                        .eq('name', item.name)
                        .eq('site', parentSite)
                        .is('container_id', null)
                        .single();

                    if (globalItem) {
                        const newGlobalQty = Math.max(0, globalItem.quantity + diff);
                        await supabase
                            .from('inventory')
                            .update({ quantity: newGlobalQty })
                            .eq('id', globalItem.id);
                    }
                }

                await supabase.from('logs').insert({
                    username: currentUser.username,
                    action: 'modification',
                    description: `Modification quantit√© ${item.name} : ${oldQty} ‚Üí ${newQty}`
                });

                closeModal('editModal');
                loadInventory();
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        // Ajouter un article
        function showAddItemModal() {
            document.getElementById('addItemModal').classList.add('active');
        }

        async function addItem() {
            const name = document.getElementById('newItemName').value.trim();
            const site = document.getElementById('newItemSite').value;
            const containerId = document.getElementById('newItemContainer').value || null;
            const quantity = parseInt(document.getElementById('newItemQuantity').value);
            const threshold = parseInt(document.getElementById('newItemThreshold').value);
            const type = document.getElementById('newItemType').value;
            const category = document.getElementById('newItemCategory').value;

            if (!name) {
                alert('Veuillez saisir un nom');
                return;
            }

            try {
                await supabase.from('inventory').insert({
                    name,
                    site,
                    container_id: containerId ? parseInt(containerId) : null,
                    quantity,
                    min_threshold: threshold,
                    type,
                    category
                });

                await supabase.from('logs').insert({
                    username: currentUser.username,
                    action: 'ajout',
                    description: `Ajout article : ${name} (${quantity} unit√©s)`
                });

                closeModal('addItemModal');
                loadInventory();
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        async function deleteItem(itemId, itemName) {
            if (!confirm(`Supprimer d√©finitivement l'article "${itemName}" ?`)) return;

            try {
                await supabase
                    .from('inventory')
                    .delete()
                    .eq('id', itemId);

                await supabase.from('logs').insert({
                    username: currentUser.username,
                    action: 'suppression',
                    description: `Suppression article : ${itemName}`
                });

                loadInventory();
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        // Gestion des utilisateurs
        async function loadUsers() {
            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .order('username');

                const { data: allRoles } = await supabase
                    .from('user_roles')
                    .select('*, containers(name)');

                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = '';

                users.forEach(user => {
                    const userRolesList = allRoles.filter(r => r.username === user.username);
                    
                    const rolesHTML = userRolesList.map(role => {
                        let badge = '';
                        let text = '';
                        
                        switch(role.role_type) {
                            case 'admin':
                                badge = 'badge-admin';
                                text = 'Admin';
                                break;
                            case 'chef-poste':
                                badge = 'badge-chef-poste';
                                text = `Chef poste ${role.site}`;
                                break;
                            case 'chef-equipe':
                                badge = 'badge-chef-equipe';
                                text = `Chef √©quipe ${role.site}`;
                                break;
                            case 'chef-binome':
                                badge = 'badge-chef-binome';
                                text = role.containers ? role.containers.name : 'Bin√¥me';
                                break;
                        }
                        
                        return `<span class="badge ${badge}">${text}</span>`;
                    }).join(' ');

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.firstname || '-'}</td>
                        <td>${rolesHTML || '<em>Aucun r√¥le</em>'}</td>
                        <td>
                            <button class="btn btn-small" onclick="manageRoles('${user.username}')">G√©rer r√¥les</button>
                            <button class="btn btn-small btn-danger" onclick="deleteUser('${user.username}')">Supprimer</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error('Erreur chargement utilisateurs:', err);
            }
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').classList.add('active');
        }

        async function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const firstname = document.getElementById('newFirstname').value.trim();

            if (!username || !password) {
                alert('Identifiant et mot de passe obligatoires');
                return;
            }

            try {
                await supabase.from('users').insert({
                    username,
                    password,
                    firstname,
                    role: 'user',
                    site: null
                });

                await supabase.from('logs').insert({
                    username: currentUser.username,
                    action: 'creation_user',
                    description: `Cr√©ation utilisateur : ${username}`
                });

                closeModal('addUserModal');
                loadUsers();
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        async function deleteUser(username) {
            if (!confirm(`Supprimer l'utilisateur ${username} ?`)) return;

            try {
                await supabase.from('users').delete().eq('username', username);
                await supabase.from('logs').insert({
                    username: currentUser.username,
                    action: 'suppression_user',
                    description: `Suppression utilisateur : ${username}`
                });
                loadUsers();
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        async function manageRoles(username) {
            document.getElementById('rolesUsername').textContent = username;
            document.getElementById('manageRolesModal').classList.add('active');
            document.getElementById('addRoleForm').classList.add('hidden');

            // Charger les r√¥les actuels
            const { data: roles } = await supabase
                .from('user_roles')
                .select('*, containers(name)')
                .eq('username', username);

            const rolesDiv = document.getElementById('rolesManagement');
            rolesDiv.innerHTML = '';

            if (roles && roles.length > 0) {
                roles.forEach(role => {
                    const roleCard = document.createElement('div');
                    roleCard.style.cssText = 'padding: 15px; margin: 10px 0; background: #f9fafb; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;';
                    
                    let roleText = '';
                    switch(role.role_type) {
                        case 'admin':
                            roleText = 'Administrateur';
                            break;
                        case 'chef-poste':
                            roleText = `Chef de poste - ${role.site}`;
                            break;
                        case 'chef-equipe':
                            roleText = `Chef d'√©quipe - ${role.site}`;
                            break;
                        case 'chef-binome':
                            roleText = `Chef de bin√¥me - ${role.containers ? role.containers.name : 'Conteneur inconnu'}`;
                            break;
                    }

                    roleCard.innerHTML = `
                        <span>${roleText}</span>
                        <button class="btn btn-small btn-danger" onclick="deleteRole(${role.id}, '${username}')">Retirer</button>
                    `;
                    rolesDiv.appendChild(roleCard);
                });
            } else {
                rolesDiv.innerHTML = '<p><em>Aucun r√¥le assign√©</em></p>';
            }

            // Stocker le username pour l'ajout de r√¥le
            window.currentRoleUsername = username;
        }

        function showAddRoleForm() {
            document.getElementById('addRoleForm').classList.remove('hidden');
        }

        async function addRole() {
            const username = window.currentRoleUsername;
            const roleType = document.getElementById('newRoleType').value;
            const site = document.getElementById('newRoleSite').value || null;
            const containerId = document.getElementById('newRoleContainer').value || null;

            try {
                await supabase.from('user_roles').insert({
                    username,
                    role_type: roleType,
                    site,
                    container_id: containerId ? parseInt(containerId) : null
                });

                await supabase.from('logs').insert({
                    username: currentUser.username,
                    action: 'ajout_role',
                    description: `Ajout r√¥le ${roleType} pour ${username}`
                });

                manageRoles(username);
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        async function deleteRole(roleId, username) {
            if (!confirm('Retirer ce r√¥le ?')) return;

            try {
                await supabase.from('user_roles').delete().eq('id', roleId);
                await supabase.from('logs').insert({
                    username: currentUser.username,
                    action: 'retrait_role',
                    description: `Retrait r√¥le pour ${username}`
                });
                manageRoles(username);
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        // Gestion des conteneurs
        async function loadContainersTable() {
            try {
                const { data } = await supabase
                    .from('containers')
                    .select('*')
                    .order('parent_site', { ascending: true })
                    .order('name', { ascending: true });

                const tbody = document.getElementById('containersTable');
                tbody.innerHTML = '';

                data.forEach(container => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${container.name}</td>
                        <td>${container.type === 'sac' ? 'Sac de secours' : 'Tour de soins'}</td>
                        <td>${container.parent_site.toUpperCase()}</td>
                        <td>${container.active ? '‚úÖ' : '‚ùå'}</td>
                        <td>
                            <button class="btn btn-small" onclick="toggleContainer(${container.id}, ${!container.active})">${container.active ? 'D√©sactiver' : 'Activer'}</button>
                            <button class="btn btn-small btn-danger" onclick="deleteContainer(${container.id}, '${container.name}')">Supprimer</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error('Erreur chargement conteneurs:', err);
            }
        }

        function showAddContainerModal() {
            document.getElementById('addContainerModal').classList.add('active');
        }

        async function addContainer() {
            const name = document.getElementById('newContainerName').value.trim();
            const type = document.getElementById('newContainerType').value;
            const site = document.getElementById('newContainerSite').value;

            if (!name) {
                alert('Veuillez saisir un nom');
                return;
            }

            try {
                await supabase.from('containers').insert({
                    name,
                    type,
                    parent_site: site,
                    active: true
                });

                await supabase.from('logs').insert({
                    username: currentUser.username,
                    action: 'creation_container',
                    description: `Cr√©ation conteneur : ${name} (${type})`
                });

                closeModal('addContainerModal');
                loadContainersTable();
                loadContainers();
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        async function toggleContainer(containerId, newState) {
            try {
                await supabase
                    .from('containers')
                    .update({ active: newState })
                    .eq('id', containerId);

                await supabase.from('logs').insert({
                    username: currentUser.username,
                    action: 'modification_container',
                    description: `Conteneur ${newState ? 'activ√©' : 'd√©sactiv√©'}`
                });

                loadContainersTable();
                loadContainers();
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        async function deleteContainer(containerId, containerName) {
            if (!confirm(`Supprimer le conteneur "${containerName}" ?\nTous les articles associ√©s seront √©galement supprim√©s.`)) return;

            try {
                await supabase
                    .from('containers')
                    .delete()
                    .eq('id', containerId);

                await supabase.from('logs').insert({
                    username: currentUser.username,
                    action: 'suppression_container',
                    description: `Suppression conteneur : ${containerName}`
                });

                loadContainersTable();
                loadContainers();
            } catch (err) {
                alert('Erreur : ' + err.message);
            }
        }

        // Historique
        async function loadLogs() {
            try {
                const { data } = await supabase
                    .from('logs')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(100);

                const tbody = document.getElementById('logsTable');
                tbody.innerHTML = '';

                data.forEach(log => {
                    const row = document.createElement('tr');
                    const date = new Date(log.timestamp).toLocaleString('fr-FR');
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${log.username}</td>
                        <td>${log.action}</td>
                        <td>${log.description}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error('Erreur chargement logs:', err);
            }
        }

        // Utilitaires
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Fermer les modales en cliquant en dehors
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
